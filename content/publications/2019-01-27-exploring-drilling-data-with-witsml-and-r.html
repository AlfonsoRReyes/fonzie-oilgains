---
title: Exploring drilling data from the Volve dataset with WITSML and R
author: Alfonso R. Reyes
date: '2019-01-27'
categories:
  - drilling
  - data structures
  - Volve
slug: exploring-drilling-data-from-volve-dataset-witsml-r
image: witsml-cover.png
---



<div id="introduction" class="section level1">
<h1>Introduction</h1>
<p>This time we will be exploring drilling data that is stored using the industry standard <a href="https://www.energistics.org/portfolio/witsml-data-standards/">WITSML</a>. This format is widely used in the industry in drilling, completion and intervention operations, specifically for real-time surveillance. WITSML stands for <em>Wellsite Information Transfer Standard Markup Language</em>. It has a series of rules to save the data as a consistent schema but essentially is XML. Software developers and IT professionals in the oil industry know it very well. They mostly use in-house developed scripts, SDK<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a> in <a href="https://github.com/hashmapinc/WitsmlObjectsLibrary">Java</a>, [.Net]<a href="#fn2" class="footnote-ref" id="fnref2"><sup>2</sup></a>, [C#]<a href="#fn3" class="footnote-ref" id="fnref3"><sup>3</sup></a>, or applications provided by vendors. This standard is essential to send and receive data between the rig and the offices or servers.</p>
<p>Since we are not writing for software developers or IT techs but for <strong>petroleum engineers</strong>, we need to know at least the basics of WITSML. We don’t need to be experts on the subject but at least get familiar with the shape of the data, manipulation, perform some data exploration, and ultimately, be prepared, or know, what they are talking about when it is time to build an artificial intelligence agent based on a machine learning algorithm.</p>
<blockquote>
<p>On Artificial Intelligence. Again, let’s touch Earth here. There is no robot, or Skynet Terminator, or an intelligent, cognitive entity in AI. Artificial Intelligence, or AI, is about making agents or applications to perform a repetitive or boring tasks that otherwise would be peformed by a human being. It is simple math, statistics and computer science.</p>
</blockquote>
</div>
<div id="motivation" class="section level1">
<h1>Motivation</h1>
<p>I have always been intrigued by <code>WITSML</code>. Not being a drilling engineer kepts me some distance away from the daily touch with this type of data. When I had the chance, I have explored the WITSML data with a XML viewer and one thing is clear: this is not your regular nice, rectangular data, or table, that we work every day. WITSML uses a <a href="https://medium.freecodecamp.org/all-you-need-to-know-about-tree-data-structures-bceacb85490c">hierarchical</a> data structure, pretty similar to a tree: branches and leaves. This makes it very unusual to those who are familiar with just row and columns tables. What we will try to do in this lecture is getting a basic understanding of a different <a href="https://en.wikipedia.org/wiki/Data_structure">data structure</a>. As a matter of fact, I find <em>hierarchical data structures</em> very applicable to production and reservoir engineering because they give us a lot of freedom in creating multiple levels for our data.</p>
</div>
<div id="witsml-and-the-volve-drilling-dataset" class="section level1">
<h1>WITSML and the Volve Drilling Dataset</h1>
<p>We were very fortunate of getting the <a href="https://www.equinor.com/en/news/14jun2018-disclosing-volve-data.html">Volve dataset</a> published 7 months ago by <a href="https://www.equinor.com/en.html">Equinor</a>. It covers a wide array of data from different disciplines (production, reservoir, geophysics, drilling, completion, logging, etc.), with data coming in different formats. It is a very good exercise of data science for exploring the data and making discoveries.</p>
<p>Here is a view of all the wells that are storing data in WITSML format:</p>
<p><img src="/img/witsml-all_wells.png" width="450px" style="display: block; margin: auto;" /></p>
<p>Look at the size of each folder. They are considerable large if we compare them to the usual files we manage every day. I am choosing the folder in row 22 (well 9f9), one of the smaller data containers (27.3 MB). If the data operations we perform here are all correct, then , generalized, they should apply well to any of the larger WITSML datasets.</p>
<p>A typical well with data stored in WITSML would look like this:</p>
<p><img src="/img/witsml-typical_well.png" width="300px" style="display: block; margin: auto;" /></p>
<p>From all these folders, let’s focus today in the <strong>well trajectory</strong> dataset.</p>
<p>I downloaded all the drilling data for Volve which is about 26.8 GB. Not that big if we compare to the seismic files of 1.2 and 2.4 terabytes. I chose the <code>trajectory</code> folder for well <code>Norway-Statoil-NO 15_$47$_9-F-9</code> because it seems complex enough to studying it. Besides, it wasn’t too big: around 27 MB. After learning from it, we could apply our data conversion algorithms to simpler datasets.</p>
</div>
<div id="the-trajectory-folder-and-files" class="section level1">
<h1>The <code>trajectory</code> folder and files</h1>
<p>The <code>trajectory</code> folder is very simple. It contains WITSML files and a metadata information file (not important at this time). The folder could contain more than one file. We will see in another lecture wells with more than one trajectory file. In our example, the WITSML file has the name of <code>1.xml</code>. We will be reading it in few seconds.</p>
<p><img src="/img/witsml-trajectory_folder.png" width="500px" style="display: block; margin: auto;" /></p>
</div>
<div id="parts-of-the-trajectory-dataset" class="section level1">
<h1>Parts of the <code>trajectory</code> dataset</h1>
<p>Let’s take a look first at the <code>trajectory</code> WITSML file. We are starting with a collapsed tree so it doesn’t take too much space of the screen. The <code>(+)</code> sign on the left means that it will expand further at that node.</p>
<p><img src="/img/witsml-collapsed.png" width="850px" style="display: block; margin: auto;" /></p>
<div id="the-two-major-nodes" class="section level2">
<h2>The two major nodes</h2>
<p>Starting by the top, in the second line, see the first node. <code>trajectorys</code>. This is the <strong>root</strong> node. If you see one <code>(-)</code> sign on its left, it means it has been expanded. Following on the right, in red, you see labels such as <code>xmlns</code>, <code>xlmns:xsi</code>, and <code>version</code>. These are <strong>attributes</strong> of <code>trajectorys</code>. They are not <strong>nodes</strong> but <strong>attributes</strong>.</p>
<p>Under the root node <code>trajectorys</code> you see that it has only one child called <code>trajectory</code>. If you see that is has a <code>(-)</code> sign, then it has been expanded showing all its dependent nodes.</p>
<p>So, there are then two major nodes: <code>trajectorys</code> and <code>trajectory</code>. Everything else exists under <code>trajectory</code>.</p>
</div>
<div id="secondary-nodes" class="section level2">
<h2>Secondary nodes</h2>
<p>There is a group of nodes that coexists at the same level of the most important node which is <code>trajectoryStation</code>. This group of nodes is what we call <code>siblings</code> of <code>trajectoryStation</code>. These nodes are:</p>
<pre><code>nameWell
nameWellBore
name
objectGrowing
dTimTrajStart
dTimTrajEnd
mdMn
mdMx
gridCorUsed
aziVertSect
dispNsVertSectOrig
dispEwVertSectOrig
aziRef
...
...
...
commonData</code></pre>
<p>The three dots correspond to <code>trajectoryStation</code> items.</p>
<p><img src="/img/witsml-orphans.png" width="500px" style="display: block; margin: auto;" /></p>
<p>Some of these nodes will have children, others will just contain values as is the case of the nodes that go from <code>nameWell</code> up to <code>aziRef</code>.</p>
<p>Some of these nodes are standalone and other have dependent nodes or children. We will see later how we find that out without having to expand each of the nodes.</p>
<p>The node <code>commonData</code>, for instance, is one that has children. That node will require special treatment to retrieve its data.</p>
</div>
<div id="the-measurement-nodes" class="section level2">
<h2>The measurement nodes</h2>
<p>The nodes <code>trajectoryStation</code> are the most important nodes in the whole dataset. They actually using very well this hierarchical data structure to keep track of the trajectory of the well. Each of the nodes for <code>trajectoryStation</code> carries a unique measurement and a unique identifier called <code>uid</code>.</p>
<p>The node <code>trajectoryStation</code> has also child nodes as we show below for the first child member.</p>
<div class="figure" style="text-align: center"><span id="fig:tS-incomplete"></span>
<img src="/img/witsml-trajectoryStation.png" alt="trajectoryStation with incomplete variables" width="600px" />
<p class="caption">
Figure 1: trajectoryStation with incomplete variables
</p>
</div>
<p>Note that on the right of <code>trajectoryStation</code> there is a keyword named <code>uid</code>. As we saw before on the root node, the label on the right is called an <strong>attribute</strong> of the node. In this particular case, that <code>uid</code> is the unique identifier or <code>uid</code> of that measurement point. Keep in mind that all of them are unique.</p>
<p>Another interesting finding is that not all <code>trajectoryStation</code> nodes have the same number of variables. Compare the figure above (Fig. <a href="#fig:tS-incomplete">1</a>) with this coming from a similarly named node in Fig. <a href="#fig:tS-complete">2</a>:</p>
<div class="figure" style="text-align: center"><span id="fig:tS-complete"></span>
<img src="/img/witsml_tS_complete.png" alt="trajectoryStation node with all its variables" width="500px" />
<p class="caption">
Figure 2: trajectoryStation node with all its variables
</p>
</div>
<p>This hierarchical structure, as we can see, is very flexible. If there are not values, or measurements, they will not take space during storage. In tables or dataframes, they would usually be present but filled with <strong>NA</strong>s.</p>
</div>
</div>
<div id="reading-a-witsml-file" class="section level1">
<h1>Reading a WITSML file</h1>
<p>Now it’s time to get our hands dirty and do a bit of data science.</p>
<div id="loading-the-packages" class="section level2">
<h2>Loading the packages</h2>
<p>We will use two packages: <code>xml2</code>, <code>data.table</code> and <code>dplyr</code>. <code>xml2</code> will take care of reading the WITSML or XML files, while <code>dplyr</code> and <code>data.table</code> will be our workhorses for dataframe generation and data manipulation. The other packages will be used at the end of the article for nesting structure and plotting. I could have just used <code>dplyr</code> but I wanted to show you both table libraries.</p>
<pre class="r"><code># load libraries
library(xml2)
library(data.table)
library(dplyr)
library(tibble)
library(tidyr)
library(purrr)
library(ggplot2)</code></pre>
</div>
<div id="list-and-load-the-xml-files" class="section level2">
<h2>List and load the XML files</h2>
<ul>
<li>Using a relatively small folder of 27 MB.</li>
<li>well <code>Norway-Statoil-NO 15_$47$_9-F-9</code></li>
<li>we show only show few of the files with their complete full name</li>
</ul>
<pre class="r"><code>all_files_xml &lt;- list.files(&quot;./witsml&quot;, recursive = TRUE, full.names = TRUE, 
                        include.dirs = TRUE, pattern = &quot;*.xml&quot;)

# indices in R start at 1, not zero as in Python
all_files_xml[1:5]
#&gt; [1] &quot;./witsml/Norway-Statoil-NO 15_$47$_9-F-4/_wellInfo/NO 15_$47$_9-F-4 (5e023a7f-1b34-4948-81ca-286bba72793b).xml&quot;            
#&gt; [2] &quot;./witsml/Norway-Statoil-NO 15_$47$_9-F-4/1/_wellboreInfo/NO 15_$47$_9-F-4 (dbffce7a-74d8-4443-8b7e-b937e5fede95)(NULL).xml&quot;
#&gt; [3] &quot;./witsml/Norway-Statoil-NO 15_$47$_9-F-4/1/bhaRun/1.xml&quot;                                                                   
#&gt; [4] &quot;./witsml/Norway-Statoil-NO 15_$47$_9-F-4/1/bhaRun/2.xml&quot;                                                                   
#&gt; [5] &quot;./witsml/Norway-Statoil-NO 15_$47$_9-F-4/1/bhaRun/3.xml&quot;</code></pre>
<div id="select-the-trajectory-file" class="section level3">
<h3>Select the trajectory file</h3>
<pre class="r"><code># get the file for trajectory
traj_files &lt;- grep(pattern = &quot;trajectory&quot;, ignore.case = TRUE, 
                   value = TRUE, x = all_files_xml)
traj_files
#&gt; [1] &quot;./witsml/Norway-Statoil-NO 15_$47$_9-F-4/1/trajectory/1.xml&quot;
#&gt; [2] &quot;./witsml/Norway-Statoil-NO 15_$47$_9-F-7/1/trajectory/1.xml&quot;
#&gt; [3] &quot;./witsml/Norway-Statoil-NO 15_$47$_9-F-9/1/trajectory/1.xml&quot;</code></pre>
</div>
<div id="load-the-selected-witsml-file" class="section level3">
<h3>Load the selected WITSML file</h3>
<pre class="r"><code>dat &lt;- read_xml(traj_files[3])
dat_9f9 &lt;- dat</code></pre>
<p>Retrieve some information:</p>
<pre class="r"><code># some introspection
xml_name(dat)
#&gt; [1] &quot;trajectorys&quot;
xml_children(dat)
#&gt; {xml_nodeset (1)}
#&gt; [1] &lt;trajectory uidWell=&quot;432612d4-7a1b-464d-b89a-9783d4606a96&quot; uidWellbo ...

# name of the child node
xml_name(xml_children(dat))
#&gt; [1] &quot;trajectory&quot;
xml_name(xml_child(dat))
#&gt; [1] &quot;trajectory&quot;</code></pre>
</div>
</div>
<div id="some-introspection-of-the-xml-object" class="section level2">
<h2>Some introspection of the XML object</h2>
<div id="first-25-nodes" class="section level3">
<h3>First 25 nodes</h3>
<pre class="r"><code># strip default namespaces from the document
xml_ns_strip( dat )
all_nodes &lt;- dat %&gt;% 
    xml_find_all( &#39;//*&#39;) %&gt;% 
    xml_path()
    
all_nodes[1:25]                   # show only the first elements
#&gt;  [1] &quot;/trajectorys&quot;                                                
#&gt;  [2] &quot;/trajectorys/trajectory&quot;                                     
#&gt;  [3] &quot;/trajectorys/trajectory/nameWell&quot;                            
#&gt;  [4] &quot;/trajectorys/trajectory/nameWellbore&quot;                        
#&gt;  [5] &quot;/trajectorys/trajectory/name&quot;                                
#&gt;  [6] &quot;/trajectorys/trajectory/objectGrowing&quot;                       
#&gt;  [7] &quot;/trajectorys/trajectory/dTimTrajStart&quot;                       
#&gt;  [8] &quot;/trajectorys/trajectory/dTimTrajEnd&quot;                         
#&gt;  [9] &quot;/trajectorys/trajectory/mdMn&quot;                                
#&gt; [10] &quot;/trajectorys/trajectory/mdMx&quot;                                
#&gt; [11] &quot;/trajectorys/trajectory/magDeclUsed&quot;                         
#&gt; [12] &quot;/trajectorys/trajectory/gridCorUsed&quot;                         
#&gt; [13] &quot;/trajectorys/trajectory/aziVertSect&quot;                         
#&gt; [14] &quot;/trajectorys/trajectory/dispNsVertSectOrig&quot;                  
#&gt; [15] &quot;/trajectorys/trajectory/dispEwVertSectOrig&quot;                  
#&gt; [16] &quot;/trajectorys/trajectory/aziRef&quot;                              
#&gt; [17] &quot;/trajectorys/trajectory/trajectoryStation[1]&quot;                
#&gt; [18] &quot;/trajectorys/trajectory/trajectoryStation[1]/dTimStn&quot;        
#&gt; [19] &quot;/trajectorys/trajectory/trajectoryStation[1]/typeTrajStation&quot;
#&gt; [20] &quot;/trajectorys/trajectory/trajectoryStation[1]/md&quot;             
#&gt; [21] &quot;/trajectorys/trajectory/trajectoryStation[1]/tvd&quot;            
#&gt; [22] &quot;/trajectorys/trajectory/trajectoryStation[1]/incl&quot;           
#&gt; [23] &quot;/trajectorys/trajectory/trajectoryStation[1]/azi&quot;            
#&gt; [24] &quot;/trajectorys/trajectory/trajectoryStation[1]/dispNs&quot;         
#&gt; [25] &quot;/trajectorys/trajectory/trajectoryStation[1]/dispEw&quot;</code></pre>
</div>
<div id="total-number-of-nodes" class="section level3">
<h3>Total number of nodes</h3>
<pre class="r"><code># get the number of elements
dat &lt;- xml_ns_strip( dat )
noe &lt;- dat %&gt;% 
    xml_find_all( &#39;//*&#39;) %&gt;% 
    xml_path() %&gt;% 
    length()
noe
#&gt; [1] 712</code></pre>
</div>
<div id="last-25-nodes" class="section level3">
<h3>Last 25 nodes</h3>
<pre class="r"><code># let&#39;s see the last 25
tail(all_nodes, 25)
#&gt;  [1] &quot;/trajectorys/trajectory/trajectoryStation[25]/dls&quot;                       
#&gt;  [2] &quot;/trajectorys/trajectory/trajectoryStation[25]/rateTurn&quot;                  
#&gt;  [3] &quot;/trajectorys/trajectory/trajectoryStation[25]/rateBuild&quot;                 
#&gt;  [4] &quot;/trajectorys/trajectory/trajectoryStation[25]/gravAccelCorUsed&quot;          
#&gt;  [5] &quot;/trajectorys/trajectory/trajectoryStation[25]/magXAxialCorUsed&quot;          
#&gt;  [6] &quot;/trajectorys/trajectory/trajectoryStation[25]/sagCorUsed&quot;                
#&gt;  [7] &quot;/trajectorys/trajectory/trajectoryStation[25]/magDrlstrCorUsed&quot;          
#&gt;  [8] &quot;/trajectorys/trajectory/trajectoryStation[25]/statusTrajStation&quot;         
#&gt;  [9] &quot;/trajectorys/trajectory/trajectoryStation[25]/corUsed&quot;                   
#&gt; [10] &quot;/trajectorys/trajectory/trajectoryStation[25]/corUsed/stnGridCorUsed&quot;    
#&gt; [11] &quot;/trajectorys/trajectory/trajectoryStation[25]/corUsed/dirSensorOffset&quot;   
#&gt; [12] &quot;/trajectorys/trajectory/trajectoryStation[25]/commonData&quot;                
#&gt; [13] &quot;/trajectorys/trajectory/trajectoryStation[25]/commonData/sourceName&quot;     
#&gt; [14] &quot;/trajectorys/trajectory/trajectoryStation[25]/commonData/dTimCreation&quot;   
#&gt; [15] &quot;/trajectorys/trajectory/trajectoryStation[25]/commonData/dTimLastChange&quot; 
#&gt; [16] &quot;/trajectorys/trajectory/trajectoryStation[25]/commonData/itemState&quot;      
#&gt; [17] &quot;/trajectorys/trajectory/trajectoryStation[25]/commonData/priv_customData&quot;
#&gt; [18] &quot;/trajectorys/trajectory/commonData&quot;                                      
#&gt; [19] &quot;/trajectorys/trajectory/commonData/sourceName&quot;                           
#&gt; [20] &quot;/trajectorys/trajectory/commonData/dTimCreation&quot;                         
#&gt; [21] &quot;/trajectorys/trajectory/commonData/dTimLastChange&quot;                       
#&gt; [22] &quot;/trajectorys/trajectory/commonData/itemState&quot;                            
#&gt; [23] &quot;/trajectorys/trajectory/commonData/priv_userOwner&quot;                       
#&gt; [24] &quot;/trajectorys/trajectory/commonData/priv_ipOwner&quot;                         
#&gt; [25] &quot;/trajectorys/trajectory/commonData/priv_dTimReceived&quot;</code></pre>
</div>
</div>
</div>
<div id="getting-data-from-nodes-and-subnodes" class="section level1">
<h1>Getting data from nodes and subnodes</h1>
<p>As we described succintly above there are four main groups of nodes that we are interested in:</p>
<ol style="list-style-type: decimal">
<li>The root node</li>
<li>The <code>trajectory</code> node</li>
<li>The measurements node <code>trajectoryStation</code> and subnodes</li>
<li>The siblings of the measurements nodes</li>
</ol>
<p>Our task is putting together all the variables and their corresponding values in a data structure that we are familiar with: a table. This step may not totally necessary if we have the proper software or tools that do the collection and search in the background for us. For the time being, let’s take like it were a <strong>data anatomy</strong> lesson.</p>
<div id="the-root-node-trajectorys" class="section level2">
<h2>The root node, <code>trajectorys</code></h2>
<p>This is the parent of the <code>trajectory</code> node. It carries not so meaningful information that I can see.</p>
<pre class="r"><code># attributes for the root node
trajectorys &lt;- xml_find_first( dat, &quot;//trajectorys&quot;)
xml_attrs(trajectorys)
#&gt;                                     version 
#&gt;                                   &quot;1.4.1.1&quot; 
#&gt;                                   xmlns:xsi 
#&gt; &quot;http://www.w3.org/2001/XMLSchema-instance&quot;
xml_name(trajectorys)
#&gt; [1] &quot;trajectorys&quot;
xml_siblings(trajectorys)    # no siblings because it is the root
#&gt; {xml_nodeset (0)}</code></pre>
</div>
<div id="the-trajectory-node" class="section level2">
<h2>The <code>trajectory</code> node</h2>
<div id="trajectory-summary" class="section level3">
<h3><code>trajectory</code> summary</h3>
<p>The <code>trajectory</code> node has two sub-levels of nodes: the measurement nodes (<code>trajectoryStation</code>) and the siblings that carry metadata for the <code>trajectoryStation</code> nodes.</p>
<pre class="r"><code># attributes of the trajectory node
trajectory &lt;- xml_find_first( dat, &quot;//trajectory&quot;)
xml_attrs(trajectory)
#&gt;                                uidWell 
#&gt; &quot;432612d4-7a1b-464d-b89a-9783d4606a96&quot; 
#&gt;                            uidWellbore 
#&gt; &quot;d1c7a0d7-afa6-487e-aa4a-e34adc091a9c&quot; 
#&gt;                                    uid 
#&gt;                              &quot;4VIRG33&quot;

# names of the parent node
xml_name(xml_parent(trajectory))
#&gt; [1] &quot;trajectorys&quot;

# name of the current node
xml_name(trajectory)
#&gt; [1] &quot;trajectory&quot;</code></pre>
<pre class="r"><code># name of the child nodes
xml_name(xml_children(trajectory))
#&gt;  [1] &quot;nameWell&quot;           &quot;nameWellbore&quot;       &quot;name&quot;              
#&gt;  [4] &quot;objectGrowing&quot;      &quot;dTimTrajStart&quot;      &quot;dTimTrajEnd&quot;       
#&gt;  [7] &quot;mdMn&quot;               &quot;mdMx&quot;               &quot;magDeclUsed&quot;       
#&gt; [10] &quot;gridCorUsed&quot;        &quot;aziVertSect&quot;        &quot;dispNsVertSectOrig&quot;
#&gt; [13] &quot;dispEwVertSectOrig&quot; &quot;aziRef&quot;             &quot;trajectoryStation&quot; 
#&gt; [16] &quot;trajectoryStation&quot;  &quot;trajectoryStation&quot;  &quot;trajectoryStation&quot; 
#&gt; [19] &quot;trajectoryStation&quot;  &quot;trajectoryStation&quot;  &quot;trajectoryStation&quot; 
#&gt; [22] &quot;trajectoryStation&quot;  &quot;trajectoryStation&quot;  &quot;trajectoryStation&quot; 
#&gt; [25] &quot;trajectoryStation&quot;  &quot;trajectoryStation&quot;  &quot;trajectoryStation&quot; 
#&gt; [28] &quot;trajectoryStation&quot;  &quot;trajectoryStation&quot;  &quot;trajectoryStation&quot; 
#&gt; [31] &quot;trajectoryStation&quot;  &quot;trajectoryStation&quot;  &quot;trajectoryStation&quot; 
#&gt; [34] &quot;trajectoryStation&quot;  &quot;trajectoryStation&quot;  &quot;trajectoryStation&quot; 
#&gt; [37] &quot;trajectoryStation&quot;  &quot;trajectoryStation&quot;  &quot;trajectoryStation&quot; 
#&gt; [40] &quot;commonData&quot;</code></pre>
</div>
<div id="trajectory-children.-method-1" class="section level3">
<h3><code>trajectory</code> children. Method 1</h3>
<pre class="r"><code># trajectoryStation children nodes
xml_name(xml_children(xml_find_all(dat, &quot;//trajectorys/trajectory&quot; )))
#&gt;  [1] &quot;nameWell&quot;           &quot;nameWellbore&quot;       &quot;name&quot;              
#&gt;  [4] &quot;objectGrowing&quot;      &quot;dTimTrajStart&quot;      &quot;dTimTrajEnd&quot;       
#&gt;  [7] &quot;mdMn&quot;               &quot;mdMx&quot;               &quot;magDeclUsed&quot;       
#&gt; [10] &quot;gridCorUsed&quot;        &quot;aziVertSect&quot;        &quot;dispNsVertSectOrig&quot;
#&gt; [13] &quot;dispEwVertSectOrig&quot; &quot;aziRef&quot;             &quot;trajectoryStation&quot; 
#&gt; [16] &quot;trajectoryStation&quot;  &quot;trajectoryStation&quot;  &quot;trajectoryStation&quot; 
#&gt; [19] &quot;trajectoryStation&quot;  &quot;trajectoryStation&quot;  &quot;trajectoryStation&quot; 
#&gt; [22] &quot;trajectoryStation&quot;  &quot;trajectoryStation&quot;  &quot;trajectoryStation&quot; 
#&gt; [25] &quot;trajectoryStation&quot;  &quot;trajectoryStation&quot;  &quot;trajectoryStation&quot; 
#&gt; [28] &quot;trajectoryStation&quot;  &quot;trajectoryStation&quot;  &quot;trajectoryStation&quot; 
#&gt; [31] &quot;trajectoryStation&quot;  &quot;trajectoryStation&quot;  &quot;trajectoryStation&quot; 
#&gt; [34] &quot;trajectoryStation&quot;  &quot;trajectoryStation&quot;  &quot;trajectoryStation&quot; 
#&gt; [37] &quot;trajectoryStation&quot;  &quot;trajectoryStation&quot;  &quot;trajectoryStation&quot; 
#&gt; [40] &quot;commonData&quot;</code></pre>
<p>At this point we don’t know which node has children or dependents.</p>
</div>
<div id="total-number-of-nodes-under-trajectory" class="section level3">
<h3>Total number of nodes under <code>trajectory</code></h3>
<pre class="r"><code># number of trajectoryStation children nodes
length(xml_name(xml_children(xml_find_all(dat, &quot;//trajectorys/trajectory&quot; ))))
#&gt; [1] 40</code></pre>
</div>
<div id="trajectory-children.-method-2" class="section level3">
<h3><code>trajectory</code> children. Method 2</h3>
<pre class="r"><code># another way of obtaining the names of the nodes for &quot;trajectory&quot;
xml_name(xml_children(xml_find_first(dat, &quot;//trajectory&quot;)))
#&gt;  [1] &quot;nameWell&quot;           &quot;nameWellbore&quot;       &quot;name&quot;              
#&gt;  [4] &quot;objectGrowing&quot;      &quot;dTimTrajStart&quot;      &quot;dTimTrajEnd&quot;       
#&gt;  [7] &quot;mdMn&quot;               &quot;mdMx&quot;               &quot;magDeclUsed&quot;       
#&gt; [10] &quot;gridCorUsed&quot;        &quot;aziVertSect&quot;        &quot;dispNsVertSectOrig&quot;
#&gt; [13] &quot;dispEwVertSectOrig&quot; &quot;aziRef&quot;             &quot;trajectoryStation&quot; 
#&gt; [16] &quot;trajectoryStation&quot;  &quot;trajectoryStation&quot;  &quot;trajectoryStation&quot; 
#&gt; [19] &quot;trajectoryStation&quot;  &quot;trajectoryStation&quot;  &quot;trajectoryStation&quot; 
#&gt; [22] &quot;trajectoryStation&quot;  &quot;trajectoryStation&quot;  &quot;trajectoryStation&quot; 
#&gt; [25] &quot;trajectoryStation&quot;  &quot;trajectoryStation&quot;  &quot;trajectoryStation&quot; 
#&gt; [28] &quot;trajectoryStation&quot;  &quot;trajectoryStation&quot;  &quot;trajectoryStation&quot; 
#&gt; [31] &quot;trajectoryStation&quot;  &quot;trajectoryStation&quot;  &quot;trajectoryStation&quot; 
#&gt; [34] &quot;trajectoryStation&quot;  &quot;trajectoryStation&quot;  &quot;trajectoryStation&quot; 
#&gt; [37] &quot;trajectoryStation&quot;  &quot;trajectoryStation&quot;  &quot;trajectoryStation&quot; 
#&gt; [40] &quot;commonData&quot;</code></pre>
</div>
<div id="trajectory-childless-nodes-with-spec" class="section level3">
<h3><code>trajectory</code> childless nodes (with spec)</h3>
<p>If we know by specification that a node does not have dependent nodes then we could manually indicate the indices in the vector containing their names. This requires having at hand the specification or a manual inspection node by node.</p>
<pre class="r"><code># name of the orphan nodes
orphan_vars &lt;- c(1:14)        # indices are being set manually.
                              # not a very practical solution

# the first 14 children of trajectory
vars14_names &lt;- xml_name(xml_children(xml_find_first(dat,
                                                     &quot;//trajectory&quot;)))[orphan_vars]
vars14_names
#&gt;  [1] &quot;nameWell&quot;           &quot;nameWellbore&quot;       &quot;name&quot;              
#&gt;  [4] &quot;objectGrowing&quot;      &quot;dTimTrajStart&quot;      &quot;dTimTrajEnd&quot;       
#&gt;  [7] &quot;mdMn&quot;               &quot;mdMx&quot;               &quot;magDeclUsed&quot;       
#&gt; [10] &quot;gridCorUsed&quot;        &quot;aziVertSect&quot;        &quot;dispNsVertSectOrig&quot;
#&gt; [13] &quot;dispEwVertSectOrig&quot; &quot;aziRef&quot;</code></pre>
<blockquote>
<p>Later we will find a better way of getting the nodes with no dependents by building a function of our own.</p>
</blockquote>
</div>
<div id="trajectory-children.-method-3" class="section level3">
<h3><code>trajectory</code> children. Method 3</h3>
<pre class="r"><code># get all the nodes 
xml_children(dat) %&gt;%     # trajectory
    xml_children() %&gt;%    # variables and values of the children
    xml_name()            # names of the variables only
#&gt;  [1] &quot;nameWell&quot;           &quot;nameWellbore&quot;       &quot;name&quot;              
#&gt;  [4] &quot;objectGrowing&quot;      &quot;dTimTrajStart&quot;      &quot;dTimTrajEnd&quot;       
#&gt;  [7] &quot;mdMn&quot;               &quot;mdMx&quot;               &quot;magDeclUsed&quot;       
#&gt; [10] &quot;gridCorUsed&quot;        &quot;aziVertSect&quot;        &quot;dispNsVertSectOrig&quot;
#&gt; [13] &quot;dispEwVertSectOrig&quot; &quot;aziRef&quot;             &quot;trajectoryStation&quot; 
#&gt; [16] &quot;trajectoryStation&quot;  &quot;trajectoryStation&quot;  &quot;trajectoryStation&quot; 
#&gt; [19] &quot;trajectoryStation&quot;  &quot;trajectoryStation&quot;  &quot;trajectoryStation&quot; 
#&gt; [22] &quot;trajectoryStation&quot;  &quot;trajectoryStation&quot;  &quot;trajectoryStation&quot; 
#&gt; [25] &quot;trajectoryStation&quot;  &quot;trajectoryStation&quot;  &quot;trajectoryStation&quot; 
#&gt; [28] &quot;trajectoryStation&quot;  &quot;trajectoryStation&quot;  &quot;trajectoryStation&quot; 
#&gt; [31] &quot;trajectoryStation&quot;  &quot;trajectoryStation&quot;  &quot;trajectoryStation&quot; 
#&gt; [34] &quot;trajectoryStation&quot;  &quot;trajectoryStation&quot;  &quot;trajectoryStation&quot; 
#&gt; [37] &quot;trajectoryStation&quot;  &quot;trajectoryStation&quot;  &quot;trajectoryStation&quot; 
#&gt; [40] &quot;commonData&quot;</code></pre>
</div>
<div id="building-the-function-get_variables_under_node" class="section level3">
<h3>Building the function <code>get_variables_under_node()</code></h3>
<pre class="r"><code>#&#39; Get the names of variables under a node
#&#39;
#&#39; @param xml_dat a XML document
#&#39; @param node a node of the form parent_node\child_node
#&#39;
#&#39; @return a character vector with the names of the variables
#&#39; @export
#&#39;
#&#39; @examples
get_variables_under_node &lt;- function(xml_dat, node) {
    xpath &lt;- paste(&quot;//&quot;, node)
    xml_find_all(xml_dat, xpath) %&gt;% 
    xml_children() %&gt;% 
    xml_name() %&gt;% 
    unique()
}</code></pre>
</div>
<div id="getting-all-variables-under-a-specific-node" class="section level3">
<h3>Getting all variables under a specific node</h3>
<pre class="r"><code># test the function get_variables_under_node()
get_variables_under_node(dat, &quot;trajectory&quot;)
#&gt;  [1] &quot;nameWell&quot;           &quot;nameWellbore&quot;       &quot;name&quot;              
#&gt;  [4] &quot;objectGrowing&quot;      &quot;dTimTrajStart&quot;      &quot;dTimTrajEnd&quot;       
#&gt;  [7] &quot;mdMn&quot;               &quot;mdMx&quot;               &quot;magDeclUsed&quot;       
#&gt; [10] &quot;gridCorUsed&quot;        &quot;aziVertSect&quot;        &quot;dispNsVertSectOrig&quot;
#&gt; [13] &quot;dispEwVertSectOrig&quot; &quot;aziRef&quot;             &quot;trajectoryStation&quot; 
#&gt; [16] &quot;commonData&quot;</code></pre>
<pre class="r"><code>get_variables_under_node(dat, &quot;trajectory/trajectoryStation&quot;)
#&gt;  [1] &quot;dTimStn&quot;           &quot;typeTrajStation&quot;   &quot;md&quot;               
#&gt;  [4] &quot;tvd&quot;               &quot;incl&quot;              &quot;azi&quot;              
#&gt;  [7] &quot;dispNs&quot;            &quot;dispEw&quot;            &quot;vertSect&quot;         
#&gt; [10] &quot;dls&quot;               &quot;commonData&quot;        &quot;typeSurveyTool&quot;   
#&gt; [13] &quot;rateTurn&quot;          &quot;rateBuild&quot;         &quot;gravAccelCorUsed&quot; 
#&gt; [16] &quot;magXAxialCorUsed&quot;  &quot;sagCorUsed&quot;        &quot;magDrlstrCorUsed&quot; 
#&gt; [19] &quot;statusTrajStation&quot; &quot;corUsed&quot;</code></pre>
</div>
<div id="build-the-functions-how_many_children-have_children" class="section level3">
<h3>Build the functions <code>how_many_children</code>, <code>have_children</code></h3>
<p>This is the function we were looking for. A way to check if the nodes under <code>trajectory</code>, or any node, have children.</p>
<pre class="r"><code>#&#39; How many children does a parent node have
#&#39; 
#&#39; Returns a character vector with the name of the vector and the node count
#&#39; @param xml_dat a XML document
#&#39; @param node a node of the form parent_node\child_node
#&#39;
how_many_children &lt;- function(xml_dat, node) {
  vars_vector &lt;- vector(&quot;integer&quot;)
  var_names &lt;- get_variables_under_node(xml_dat, node)
  i &lt;- 1
  for (var in var_names) {
    xpath &lt;- paste(&quot;//&quot;, node, &quot;/&quot;, var)  
    num_children &lt;- max(xml_length(xml_find_all(xml_dat, xpath)))
    vars_vector[i] &lt;- num_children
    names(vars_vector)[i] &lt;- var
    # cat(i, var, vars_vector[i], &quot;\n&quot;)
    i &lt;- i + 1
  } 
  vars_vector
}</code></pre>
<p>Testing the function <code>how_many_children</code>.</p>
<pre class="r"><code># test the function how_many_children()
how_many_children(dat, &quot;trajectory&quot;)
#&gt;           nameWell       nameWellbore               name 
#&gt;                  0                  0                  0 
#&gt;      objectGrowing      dTimTrajStart        dTimTrajEnd 
#&gt;                  0                  0                  0 
#&gt;               mdMn               mdMx        magDeclUsed 
#&gt;                  0                  0                  0 
#&gt;        gridCorUsed        aziVertSect dispNsVertSectOrig 
#&gt;                  0                  0                  0 
#&gt; dispEwVertSectOrig             aziRef  trajectoryStation 
#&gt;                  0                  0                 20 
#&gt;         commonData 
#&gt;                  7</code></pre>
<blockquote>
<p>Note that only two variables have children or dependents.</p>
</blockquote>
</div>
<div id="build-the-functions-have_children-and-have_no_children" class="section level3">
<h3>Build the functions <code>have_children</code> and <code>have_no_children</code></h3>
<pre class="r"><code>#&#39; Get a vector of those nodes that have children and their count
#&#39;
#&#39; @param xml_dat 
#&#39; @param node 
#&#39;
have_children &lt;- function(xml_dat, node) {
  how_many &lt;- how_many_children(xml_dat, node)
  how_many[how_many &gt; 0]
}

#&#39; Get a vector of those nodes that do not have children and their zero count.
#&#39;
#&#39; @param xml_dat 
#&#39; @param node 
#&#39;
have_no_children &lt;- function(xml_dat, node) {
  how_many &lt;- how_many_children(xml_dat, node)
  how_many[how_many == 0]
}</code></pre>
</div>
<div id="test-for-nodes-and-dependents" class="section level3">
<h3>test for nodes and dependents</h3>
<p>Now we can easily find what nodes are childless</p>
<pre class="r"><code>have_no_children(dat, &quot;trajectory&quot;)
#&gt;           nameWell       nameWellbore               name 
#&gt;                  0                  0                  0 
#&gt;      objectGrowing      dTimTrajStart        dTimTrajEnd 
#&gt;                  0                  0                  0 
#&gt;               mdMn               mdMx        magDeclUsed 
#&gt;                  0                  0                  0 
#&gt;        gridCorUsed        aziVertSect dispNsVertSectOrig 
#&gt;                  0                  0                  0 
#&gt; dispEwVertSectOrig             aziRef 
#&gt;                  0                  0</code></pre>
<p>List only the names of the variables that have no children.</p>
<pre class="r"><code>names(have_no_children(dat, &quot;trajectory&quot;))
#&gt;  [1] &quot;nameWell&quot;           &quot;nameWellbore&quot;       &quot;name&quot;              
#&gt;  [4] &quot;objectGrowing&quot;      &quot;dTimTrajStart&quot;      &quot;dTimTrajEnd&quot;       
#&gt;  [7] &quot;mdMn&quot;               &quot;mdMx&quot;               &quot;magDeclUsed&quot;       
#&gt; [10] &quot;gridCorUsed&quot;        &quot;aziVertSect&quot;        &quot;dispNsVertSectOrig&quot;
#&gt; [13] &quot;dispEwVertSectOrig&quot; &quot;aziRef&quot;</code></pre>
</div>
</div>
<div id="nodes-under-trajectorytrajectorystation" class="section level2">
<h2>Nodes under <code>//trajectory/trajectoryStation</code></h2>
<div id="get-trajectorystation-children.-method-1" class="section level3">
<h3>Get trajectoryStation children. Method 1</h3>
<pre class="r"><code># names of the children for &quot;trajectoryStation&quot;
xml_name(xml_children(xml_find_first( dat, &quot;//trajectory/trajectoryStation&quot;)))
#&gt;  [1] &quot;dTimStn&quot;         &quot;typeTrajStation&quot; &quot;md&quot;             
#&gt;  [4] &quot;tvd&quot;             &quot;incl&quot;            &quot;azi&quot;            
#&gt;  [7] &quot;dispNs&quot;          &quot;dispEw&quot;          &quot;vertSect&quot;       
#&gt; [10] &quot;dls&quot;             &quot;commonData&quot;</code></pre>
</div>
<div id="get-trajectorystation-children.-method-2" class="section level3">
<h3>Get trajectoryStation children. Method 2</h3>
<p>This yields the same result:</p>
<pre class="r"><code># names of the nodes for &quot;trajectoryStation&quot;
xml_name(xml_children(xml_find_first(dat, &quot;//trajectoryStation&quot;)))
#&gt;  [1] &quot;dTimStn&quot;         &quot;typeTrajStation&quot; &quot;md&quot;             
#&gt;  [4] &quot;tvd&quot;             &quot;incl&quot;            &quot;azi&quot;            
#&gt;  [7] &quot;dispNs&quot;          &quot;dispEw&quot;          &quot;vertSect&quot;       
#&gt; [10] &quot;dls&quot;             &quot;commonData&quot;</code></pre>
</div>
<div id="get-attributes-of-trajectorystation" class="section level3">
<h3>Get attributes of trajectoryStation</h3>
<pre class="r"><code># find attributes of the first element of trajectoryStation found
trajectoryStation &lt;- xml_find_first(dat, &quot;//trajectoryStation&quot;)
xml_attrs(x = trajectoryStation)
#&gt;                 uid 
#&gt; &quot;4VIRG33_TIE_POINT&quot;</code></pre>
</div>
<div id="number-of-measurement-stations" class="section level3">
<h3>number of measurement stations</h3>
<pre class="r"><code># find all observations for dTimStn
trajectoryStation.dTimStn &lt;- xml_find_all(dat, &quot;//trajectoryStation/dTimStn&quot;)

# we end up finding a way to calculate the number of trajectory stations
length(trajectoryStation.dTimStn)
#&gt; [1] 25</code></pre>
</div>
<div id="why-the-variables-under-trajectorystation-are-different" class="section level3">
<h3>Why the variables under trajectoryStation are different</h3>
<p>Pay attention to these two cases when we interrogate about the name of the variables under <code>trajectoryStation</code>.</p>
<p>This is asking for variables in the first node:</p>
<pre class="r"><code># name of the dependent nodes of &quot;trajectoryStation&quot;
xml_name(xml_children(xml_find_first(dat, &quot;//trajectoryStation&quot;)))
#&gt;  [1] &quot;dTimStn&quot;         &quot;typeTrajStation&quot; &quot;md&quot;             
#&gt;  [4] &quot;tvd&quot;             &quot;incl&quot;            &quot;azi&quot;            
#&gt;  [7] &quot;dispNs&quot;          &quot;dispEw&quot;          &quot;vertSect&quot;       
#&gt; [10] &quot;dls&quot;             &quot;commonData&quot;</code></pre>
<p>This is asking for variables for all the nodes and taking only the unique names, those that do not repeat:</p>
<pre class="r"><code># name of the dependent nodes of &quot;trajectoryStation&quot;
unique(xml_name(xml_children(xml_find_all(dat, &quot;//trajectoryStation&quot;))))
#&gt;  [1] &quot;dTimStn&quot;           &quot;typeTrajStation&quot;   &quot;md&quot;               
#&gt;  [4] &quot;tvd&quot;               &quot;incl&quot;              &quot;azi&quot;              
#&gt;  [7] &quot;dispNs&quot;            &quot;dispEw&quot;            &quot;vertSect&quot;         
#&gt; [10] &quot;dls&quot;               &quot;commonData&quot;        &quot;typeSurveyTool&quot;   
#&gt; [13] &quot;rateTurn&quot;          &quot;rateBuild&quot;         &quot;gravAccelCorUsed&quot; 
#&gt; [16] &quot;magXAxialCorUsed&quot;  &quot;sagCorUsed&quot;        &quot;magDrlstrCorUsed&quot; 
#&gt; [19] &quot;statusTrajStation&quot; &quot;corUsed&quot;</code></pre>
<blockquote>
<p><strong>Note</strong>. They are different because in the first case we are asking for the first node (<code>xml_find_first</code>) while in the second case we are asking for all the nodes (<code>xml_find_all</code>). This is normal. The reason of existence of hierarchical structures that doesn’t waste space in variables that are not currently used.</p>
</blockquote>
</div>
<div id="attributes-of-trajectorystation" class="section level3">
<h3>Attributes of <code>trajectoryStation</code></h3>
<pre class="r"><code># get the attributes for trajectoryStation
xml_attrs(x = trajectoryStation)
#&gt;                 uid 
#&gt; &quot;4VIRG33_TIE_POINT&quot;

# we get only the &quot;uid&quot; attribute</code></pre>
<pre class="r"><code># get the value of the attribute we found
xml_attr(x = trajectoryStation, attr = &quot;uid&quot;)
#&gt; [1] &quot;4VIRG33_TIE_POINT&quot;</code></pre>
</div>
</div>
<div id="commondata-names-and-values" class="section level2">
<h2>commonData: names and values</h2>
<p>There are two type of nodes with the same name but hang from different parents:
* <code>//trajectory/commonData</code>
* <code>//trajectoryStation/commonData</code></p>
<p>Both have different purposes.</p>
<div id="trajectorycommondata" class="section level3">
<h3><code>//trajectory/commonData</code></h3>
<p>Nodes under <code>//trajectory/commonData</code>:</p>
<pre class="r"><code># get the subnodes for //trajectory/commonData
unique(xml_name(xml_children(xml_find_all(dat, &quot;//trajectory/commonData&quot;))))
#&gt; [1] &quot;sourceName&quot;        &quot;dTimCreation&quot;      &quot;dTimLastChange&quot;   
#&gt; [4] &quot;itemState&quot;         &quot;priv_userOwner&quot;    &quot;priv_ipOwner&quot;     
#&gt; [7] &quot;priv_dTimReceived&quot;</code></pre>
<p>Number of nodes under <code>//trajectory/commonData</code>:</p>
<pre class="r"><code># number of subnodes
max(xml_length(xml_find_all(dat, &quot;//trajectory/commonData&quot;)))
#&gt; [1] 7</code></pre>
<p>Values for the nodes under <code>//trajectory/commonData</code>:</p>
<pre class="r"><code># values for the first macthing node
xml_text((xml_find_first(dat, &quot;//trajectory/commonData&quot; ) ) )
#&gt; [1] &quot;Baker Hughes2016-09-29T03:43:41.342Z2016-09-29T03:43:41.342Zactualsc-sync-bhi143.97.229.42016-09-29T03:43:41.342Z&quot;</code></pre>
</div>
<div id="trajectorystationcommondata" class="section level3">
<h3><code>//trajectoryStation/commonData</code></h3>
<p>Nodes under <code>//trajectoryStation/commonData</code>:</p>
<pre class="r"><code># get the subnodes for //trajectoryStation/commonData
unique(xml_name(xml_children(xml_find_all(dat, &quot;//trajectoryStation/commonData&quot; ) ) ))
#&gt; [1] &quot;sourceName&quot;      &quot;dTimCreation&quot;    &quot;dTimLastChange&quot;  &quot;itemState&quot;      
#&gt; [5] &quot;priv_customData&quot;</code></pre>
<p>Number of nodes under <code>//trajectoryStation/commonData</code>:</p>
<pre class="r"><code># number of subnodes for //trajectoryStation/commonData
# we use max() for the case it returns a vector with multiple nodes and lengths
max(xml_length(xml_find_all(dat, &quot;//trajectoryStation/commonData&quot;)))
#&gt; [1] 5</code></pre>
<p>Values for the nodes under <code>//trajectoryStation/commonData</code>:</p>
<pre class="r"><code># values for the first matching node
xml_text((xml_find_first(dat, &quot;//trajectoryStation/commonData&quot; ) ) )
#&gt; [1] &quot;Baker Hughes2016-09-29T03:43:41.342Z2016-09-29T03:43:41.342Zactual&quot;</code></pre>
</div>
</div>
</div>
<div id="creating-the-dataframes" class="section level1">
<h1>Creating the dataframes</h1>
<p>At this point we have figured out how to extract the names and values from nodes in a hirerarchical structure. Now, it is time to build the tables with that data.</p>
<div id="trajectory-dataframe" class="section level2">
<h2><code>trajectory</code> dataframe</h2>
<pre class="r"><code># get all attributes for trajectory node
# we try with datatable and dataframe
trajectory &lt;- xml_find_first( dat, &quot;//trajectory&quot;)
trajectory &lt;- xml_attrs(trajectory)

trajectory_attr_dt &lt;- data.table(t(trajectory))

trajectory_attr_df &lt;- data.frame(t(trajectory), stringsAsFactors = FALSE)
trajectory_attr_df
#&gt;                                uidWell
#&gt; 1 432612d4-7a1b-464d-b89a-9783d4606a96
#&gt;                            uidWellbore     uid
#&gt; 1 d1c7a0d7-afa6-487e-aa4a-e34adc091a9c 4VIRG33</code></pre>
<pre class="r"><code># This is the same way of getting a dataframe for trajectory
# get values for all the attributes of the trajectory node
# using magrittr
xml_find_first( dat, &quot;//trajectory&quot;) %&gt;% 
    xml_attrs() %&gt;% 
    t() %&gt;% 
    data.frame(stringsAsFactors = FALSE)
#&gt;                                uidWell
#&gt; 1 432612d4-7a1b-464d-b89a-9783d4606a96
#&gt;                            uidWellbore     uid
#&gt; 1 d1c7a0d7-afa6-487e-aa4a-e34adc091a9c 4VIRG33</code></pre>
</div>
<div id="siblings-of-trajectorystation" class="section level2">
<h2>Siblings of <code>trajectoryStation</code></h2>
<p>This takes only one row.</p>
<pre class="r"><code># get all the trajectory variables, with and without descendants
trajectory_children &lt;- xml_name(xml_children(xml_find_first(dat, &quot;//trajectory&quot;)))

# get only those variables without descendants. hnc: have no children
traj_hnc_names &lt;- names(have_no_children(dat, &quot;trajectory&quot;))
traj_hnc_idx &lt;- which(trajectory_children %in% traj_hnc_names)

traj_hnc &lt;- xml_text(xml_children(xml_find_first( dat, &quot;//trajectory&quot;)))[traj_hnc_idx]
names(traj_hnc) &lt;- traj_hnc_names

# dataframe and datatable
siblings_df &lt;- data.frame(t(traj_hnc), stringsAsFactors = FALSE)
siblings_df
#&gt;      nameWell  nameWellbore           name objectGrowing
#&gt; 1 NO 15/9-F-9 NO 15/9-F-9 A MWD-15/9-F-9 A         false
#&gt;              dTimTrajStart              dTimTrajEnd mdMn mdMx magDeclUsed
#&gt; 1 2016-09-28T23:59:57.000Z 2016-09-29T00:03:50.000Z    0 1206           0
#&gt;   gridCorUsed aziVertSect dispNsVertSectOrig dispEwVertSectOrig     aziRef
#&gt; 1           0           0                  0                  0 true north

siblings_dt &lt;- data.table(t(traj_hnc))</code></pre>
<div id="combine-trajectory-and-siblings-in-a-one-row-dataframe" class="section level3">
<h3>combine trajectory and siblings in a one-row dataframe</h3>
<p>We use the function <code>cbind</code> to glue the columns together.</p>
<pre class="r"><code>trajectory_dt &lt;- cbind(trajectory_attr_dt, siblings_dt)
trajectory_df &lt;- cbind(trajectory_attr_df, siblings_df)</code></pre>
<pre class="r"><code># print the table
print(as_tibble(trajectory_df))
#&gt; # A tibble: 1 x 17
#&gt;   uidWell uidWellbore uid   nameWell nameWellbore name  objectGrowing
#&gt;   &lt;chr&gt;   &lt;chr&gt;       &lt;chr&gt; &lt;chr&gt;    &lt;chr&gt;        &lt;chr&gt; &lt;chr&gt;        
#&gt; 1 432612~ d1c7a0d7-a~ 4VIR~ NO 15/9~ NO 15/9-F-9~ MWD-~ false        
#&gt; # ... with 10 more variables: dTimTrajStart &lt;chr&gt;, dTimTrajEnd &lt;chr&gt;,
#&gt; #   mdMn &lt;chr&gt;, mdMx &lt;chr&gt;, magDeclUsed &lt;chr&gt;, gridCorUsed &lt;chr&gt;,
#&gt; #   aziVertSect &lt;chr&gt;, dispNsVertSectOrig &lt;chr&gt;, dispEwVertSectOrig &lt;chr&gt;,
#&gt; #   aziRef &lt;chr&gt;</code></pre>
</div>
</div>
<div id="trajectorystation-measurements" class="section level2">
<h2><code>trajectoryStation</code> measurements</h2>
<div id="part-1-of-4-of-the-trajectorystation-dataframe" class="section level3">
<h3>Part 1 of 4 of the <code>trajectoryStation</code> dataframe</h3>
<p>Corresponds to the dataframe for the <code>trajectoryStation</code> attribute <code>uid</code>.</p>
<pre class="r"><code># get values for uid attribute of trajectoryStation
# these are the well ids
tS.uid &lt;- dat %&gt;% 
    xml_find_all(&quot;//trajectoryStation&quot;) %&gt;% 
    xml_attr(&quot;uid&quot;)

tS.uid_dt &lt;- data.table(uid = tS.uid)
tS.uid_df &lt;- data.frame(uid = tS.uid, stringsAsFactors = FALSE)

tS.uid_df
#&gt;                  uid
#&gt; 1  4VIRG33_TIE_POINT
#&gt; 2          325VIRG33
#&gt; 3          326VIRG33
#&gt; 4          327VIRG33
#&gt; 5          328VIRG33
#&gt; 6          329VIRG33
#&gt; 7          330VIRG33
#&gt; 8          331VIRG33
#&gt; 9          332VIRG33
#&gt; 10         333VIRG33
#&gt; 11         334VIRG33
#&gt; 12         335VIRG33
#&gt; 13         336VIRG33
#&gt; 14         337VIRG33
#&gt; 15         338VIRG33
#&gt; 16         339VIRG33
#&gt; 17         340VIRG33
#&gt; 18         341VIRG33
#&gt; 19         342VIRG33
#&gt; 20         343VIRG33
#&gt; 21         344VIRG33
#&gt; 22         345VIRG33
#&gt; 23         346VIRG33
#&gt; 24         347VIRG33
#&gt; 25         348VIRG33</code></pre>
<p>We could use this method to create a function that finds the number of observations, or rows, for <code>trajectoryStation</code>:</p>
<pre class="r"><code># get the number of rows for a parent node
#&#39; Get the number of rows for a parent node.
#&#39;
#&#39; @param xml_dat the xml document
#&#39; @param parent_node a node without the two forward slashes
#&#39; @param attribute the attribute of the node if available
#&#39;
#&#39; @return
#&#39; @export
#&#39;
#&#39; @examples
get_numrows_parent_node &lt;- function(xml_dat, parent_node, attribute) {
    # TODO: validate if the node has an attribute
    xml_dat %&gt;% 
    xml_find_all(paste(&quot;//&quot;, parent_node)) %&gt;%
    xml_attr(&quot;uid&quot;) %&gt;%
    length()
}

# exercise the function
parent &lt;- &quot;trajectoryStation&quot;
attrib &lt;- &quot;uid&quot;
get_numrows_parent_node(dat, parent, attrib)
#&gt; [1] 25</code></pre>
</div>
</div>
<div id="measurement-stations-or-trajectorystation" class="section level2">
<h2>measurement stations or <code>trajectoryStation</code></h2>
<pre class="r"><code># using xml_children
# we also get commonData which has children
trajectoryStation_all_names &lt;- xml_name(xml_children(xml_find_all(dat, 
                                                            &quot;//trajectoryStation&quot;)))
trajectoryStation_all_names &lt;- unique(trajectoryStation_all_names)
trajectoryStation_all_names
#&gt;  [1] &quot;dTimStn&quot;           &quot;typeTrajStation&quot;   &quot;md&quot;               
#&gt;  [4] &quot;tvd&quot;               &quot;incl&quot;              &quot;azi&quot;              
#&gt;  [7] &quot;dispNs&quot;            &quot;dispEw&quot;            &quot;vertSect&quot;         
#&gt; [10] &quot;dls&quot;               &quot;commonData&quot;        &quot;typeSurveyTool&quot;   
#&gt; [13] &quot;rateTurn&quot;          &quot;rateBuild&quot;         &quot;gravAccelCorUsed&quot; 
#&gt; [16] &quot;magXAxialCorUsed&quot;  &quot;sagCorUsed&quot;        &quot;magDrlstrCorUsed&quot; 
#&gt; [19] &quot;statusTrajStation&quot; &quot;corUsed&quot;</code></pre>
<pre class="r"><code># get the number of columns by name
# commonData is excluded (but we know that in advance)
no_commonData &lt;- which(trajectoryStation_all_names %in% c(&quot;commonData&quot;))

# get rid of commonData since it has children
trajectoryStation_names &lt;- trajectoryStation_all_names[-no_commonData] # exclude
trajectoryStation_names
#&gt;  [1] &quot;dTimStn&quot;           &quot;typeTrajStation&quot;   &quot;md&quot;               
#&gt;  [4] &quot;tvd&quot;               &quot;incl&quot;              &quot;azi&quot;              
#&gt;  [7] &quot;dispNs&quot;            &quot;dispEw&quot;            &quot;vertSect&quot;         
#&gt; [10] &quot;dls&quot;               &quot;typeSurveyTool&quot;    &quot;rateTurn&quot;         
#&gt; [13] &quot;rateBuild&quot;         &quot;gravAccelCorUsed&quot;  &quot;magXAxialCorUsed&quot; 
#&gt; [16] &quot;sagCorUsed&quot;        &quot;magDrlstrCorUsed&quot;  &quot;statusTrajStation&quot;
#&gt; [19] &quot;corUsed&quot;</code></pre>
<div id="draft-of-a-future-function" class="section level3">
<h3>draft of a future function</h3>
<pre class="r"><code># first non-automated way of getting values for the all the trajectoryStation nodes
# there are 19 variables under trajectoryStation, not including commonData which
# was manually removed
xml_dat &lt;- dat
node &lt;- &quot;trajectoryStation&quot;
max_obs &lt;- get_numrows_parent_node(dat, &quot;trajectoryStation&quot;, attribute = &quot;uid&quot;)
var_names &lt;- trajectoryStation_names  # names of the variables in a vector
li_vars &lt;- vector(&quot;list&quot;)             # vector of list
for (var in var_names) {              # iterate through all the variables
    xpath &lt;- paste(&quot;//&quot;, node, &quot;/&quot;, var)  # form the xpath
    num_children &lt;- max(xml_length(xml_find_all(dat, xpath)))
    if (num_children == 0) {  # skip if the node has children
        value_xpath &lt;- xml_text(xml_find_all(dat, xpath)) # get all the values
        vx &lt;- value_xpath                                  # make it a shorter name
        # if the variables are all not present, add NA. max=25
        # cat(var, max_obs, length(vx), &quot;\n&quot;)
        if (length(vx) &lt; max_obs) vx &lt;- c(rep(NA, max_obs - length(vx)), vx)
        li_vars[[var]] &lt;- vx
    }
}
tS_df &lt;- as.data.frame(li_vars, stringsAsFactors = FALSE)</code></pre>
<pre class="r"><code># print the table for trajectoryStation
print(as_tibble(tS_df))
#&gt; # A tibble: 25 x 18
#&gt;    dTimStn typeTrajStation md    tvd   incl  azi   dispNs dispEw vertSect
#&gt;    &lt;chr&gt;   &lt;chr&gt;           &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;  &lt;chr&gt;  &lt;chr&gt;   
#&gt;  1 2016-0~ tie in point    0     0     0     0     0      0      0       
#&gt;  2 2016-0~ gyro north see~ 145.~ 145.~ 0     0     0      0      0       
#&gt;  3 2016-0~ gyro north see~ 218.5 218.~ 0.00~ 3.44~ -0.15~ -0.04~ -0.1573~
#&gt;  4 2016-0~ gyro north see~ 259   258.~ 0.00~ 4.45~ -0.26~ -0.13~ -0.2612~
#&gt;  5 2016-0~ gyro north see~ 299.5 299.~ 0.00~ 4.20~ -0.33~ -0.30~ -0.3375~
#&gt;  6 2016-0~ gyro north see~ 340   339.~ 0.00~ 0.61~ -0.27~ -0.32~ -0.2703~
#&gt;  7 2016-0~ gyro north see~ 394.~ 394.~ 0.00~ 6.00~ 0.060~ -0.25~ 0.06012~
#&gt;  8 2016-0~ gyro north see~ 420.~ 420.~ 0.00~ 6.15~ 0.215~ -0.28~ 0.21588~
#&gt;  9 2016-0~ gyro north see~ 454.~ 454.~ 0.08~ 3.45~ -1.01~ -0.72~ -1.0151~
#&gt; 10 2016-0~ gyro north see~ 497.~ 497.~ 0.15~ 3.48~ -5.80~ -2.36~ -5.8030~
#&gt; # ... with 15 more rows, and 9 more variables: dls &lt;chr&gt;,
#&gt; #   typeSurveyTool &lt;chr&gt;, rateTurn &lt;chr&gt;, rateBuild &lt;chr&gt;,
#&gt; #   gravAccelCorUsed &lt;chr&gt;, magXAxialCorUsed &lt;chr&gt;, sagCorUsed &lt;chr&gt;,
#&gt; #   magDrlstrCorUsed &lt;chr&gt;, statusTrajStation &lt;chr&gt;</code></pre>
<pre class="r"><code>names(tS_df)
#&gt;  [1] &quot;dTimStn&quot;           &quot;typeTrajStation&quot;   &quot;md&quot;               
#&gt;  [4] &quot;tvd&quot;               &quot;incl&quot;              &quot;azi&quot;              
#&gt;  [7] &quot;dispNs&quot;            &quot;dispEw&quot;            &quot;vertSect&quot;         
#&gt; [10] &quot;dls&quot;               &quot;typeSurveyTool&quot;    &quot;rateTurn&quot;         
#&gt; [13] &quot;rateBuild&quot;         &quot;gravAccelCorUsed&quot;  &quot;magXAxialCorUsed&quot; 
#&gt; [16] &quot;sagCorUsed&quot;        &quot;magDrlstrCorUsed&quot;  &quot;statusTrajStation&quot;</code></pre>
<pre class="r"><code># get the names of variables under a node
get_variables_under_node &lt;- function(xml_dat, node) {
    xpath &lt;- paste(&quot;//&quot;, node)
    xml_find_all(xml_dat, xpath) %&gt;% 
    xml_children() %&gt;% 
    xml_name() %&gt;% 
    unique()
}

tS.cD_names &lt;- get_variables_under_node(dat, &quot;trajectoryStation/commonData&quot;)
tS.cD_names
#&gt; [1] &quot;sourceName&quot;      &quot;dTimCreation&quot;    &quot;dTimLastChange&quot;  &quot;itemState&quot;      
#&gt; [5] &quot;priv_customData&quot;</code></pre>
<pre class="r"><code># get variables under trajectoryStation
# detect what variables are standalone and which ones have children
how_many_children(dat, &quot;trajectoryStation&quot;)
#&gt;           dTimStn   typeTrajStation                md               tvd 
#&gt;                 0                 0                 0                 0 
#&gt;              incl               azi            dispNs            dispEw 
#&gt;                 0                 0                 0                 0 
#&gt;          vertSect               dls        commonData    typeSurveyTool 
#&gt;                 0                 0                 5                 0 
#&gt;          rateTurn         rateBuild  gravAccelCorUsed  magXAxialCorUsed 
#&gt;                 0                 0                 0                 0 
#&gt;        sagCorUsed  magDrlstrCorUsed statusTrajStation           corUsed 
#&gt;                 0                 0                 0                 2</code></pre>
<p>There are two variables under <code>trajectoryStation</code> that have descendants.</p>
</div>
<div id="build-the-function-nodes_as_df" class="section level3">
<h3>Build the function <code>nodes_as_df</code></h3>
<pre class="r"><code>#&#39; Converts children of a node and their values to a dataframe.
#&#39; Receives a node (do not add &#39;//&#39;), creates a vector with the variables under
#&#39; the node, iterates through each of the variables, fills uneven rows with NAs.
#&#39; It will skip a child node that contains children.
#&#39;
#&#39; @param xml_dat a xml document
#&#39; @param node a node of the form &quot;trajectoryStation/dTimStn&quot;. No need to add &quot;//&quot;
#&#39; @param max_obs 
nodes_as_df &lt;- function(xml_dat, node, max_obs) {
    li_vars &lt;- vector(&quot;list&quot;)             # vector of list
    var_names &lt;- get_variables_under_node(xml_dat, node)
    for (var in var_names) {              # iterate through all the variables
        xpath &lt;- paste(&quot;//&quot;, node, &quot;/&quot;, var)  # form the xpath
        num_children &lt;- max(xml_length(xml_find_all(xml_dat, xpath)))
        if (num_children == 0) {  # skip if the node has children
            value_xpath &lt;- xml_text(xml_find_all(xml_dat, xpath)) # get all the values
            vx &lt;- value_xpath                                  # make it a shorter name
            # if the variables are all not present, add NA. max=25
            # cat(var, max_obs, length(vx), &quot;\n&quot;)
            if (length(vx) &lt; max_obs) vx &lt;- c(rep(NA, max_obs - length(vx)), vx)
            li_vars[[var]] &lt;- vx
        }
    }
    as.data.frame(li_vars, stringsAsFactors = FALSE)
}</code></pre>
</div>
<div id="part-2-of-4-of-the-trajectorystation-dataframe" class="section level3">
<h3>Part 2 of 4 of the <code>trajectoryStation</code> dataframe</h3>
<pre class="r"><code># using function get_numrows_parent_node()
num_trajectoryStation &lt;- get_numrows_parent_node(dat, &quot;trajectoryStation&quot;, 
                                                 attribute = &quot;uid&quot;)
tS.trajectoryStation_df &lt;- nodes_as_df(dat, &quot;trajectoryStation&quot;, num_trajectoryStation)
as_tibble(tS.trajectoryStation_df)
#&gt; # A tibble: 25 x 18
#&gt;    dTimStn typeTrajStation md    tvd   incl  azi   dispNs dispEw vertSect
#&gt;    &lt;chr&gt;   &lt;chr&gt;           &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;  &lt;chr&gt;  &lt;chr&gt;   
#&gt;  1 2016-0~ tie in point    0     0     0     0     0      0      0       
#&gt;  2 2016-0~ gyro north see~ 145.~ 145.~ 0     0     0      0      0       
#&gt;  3 2016-0~ gyro north see~ 218.5 218.~ 0.00~ 3.44~ -0.15~ -0.04~ -0.1573~
#&gt;  4 2016-0~ gyro north see~ 259   258.~ 0.00~ 4.45~ -0.26~ -0.13~ -0.2612~
#&gt;  5 2016-0~ gyro north see~ 299.5 299.~ 0.00~ 4.20~ -0.33~ -0.30~ -0.3375~
#&gt;  6 2016-0~ gyro north see~ 340   339.~ 0.00~ 0.61~ -0.27~ -0.32~ -0.2703~
#&gt;  7 2016-0~ gyro north see~ 394.~ 394.~ 0.00~ 6.00~ 0.060~ -0.25~ 0.06012~
#&gt;  8 2016-0~ gyro north see~ 420.~ 420.~ 0.00~ 6.15~ 0.215~ -0.28~ 0.21588~
#&gt;  9 2016-0~ gyro north see~ 454.~ 454.~ 0.08~ 3.45~ -1.01~ -0.72~ -1.0151~
#&gt; 10 2016-0~ gyro north see~ 497.~ 497.~ 0.15~ 3.48~ -5.80~ -2.36~ -5.8030~
#&gt; # ... with 15 more rows, and 9 more variables: dls &lt;chr&gt;,
#&gt; #   typeSurveyTool &lt;chr&gt;, rateTurn &lt;chr&gt;, rateBuild &lt;chr&gt;,
#&gt; #   gravAccelCorUsed &lt;chr&gt;, magXAxialCorUsed &lt;chr&gt;, sagCorUsed &lt;chr&gt;,
#&gt; #   magDrlstrCorUsed &lt;chr&gt;, statusTrajStation &lt;chr&gt;</code></pre>
</div>
<div id="part-3-of-4-of-the-trajectorystation-dataframe-commondata" class="section level3">
<h3>Part 3 of 4 of the <code>trajectoryStation</code> dataframe: <code>commonData</code></h3>
<p>Correspond to the dataframe of <code>trajectoryStation/commonData</code>.</p>
<pre class="r"><code># cascading way
xpath &lt;- &quot;//trajectoryStation/commonData&quot;
xml_find_all(dat, xpath) %&gt;% 
    xml_children() %&gt;% 
    xml_name() %&gt;% 
    unique()
#&gt; [1] &quot;sourceName&quot;      &quot;dTimCreation&quot;    &quot;dTimLastChange&quot;  &quot;itemState&quot;      
#&gt; [5] &quot;priv_customData&quot;</code></pre>
<pre class="r"><code># get the nodes under trajectoryStation/commonData
tS.cD_df &lt;- nodes_as_df(xml_dat, node = &quot;trajectoryStation/commonData&quot;, max_obs = 25)
as_tibble(tS.cD_df)
#&gt; # A tibble: 25 x 5
#&gt;    sourceName  dTimCreation    dTimLastChange   itemState priv_customData  
#&gt;    &lt;chr&gt;       &lt;chr&gt;           &lt;chr&gt;            &lt;chr&gt;     &lt;chr&gt;            
#&gt;  1 Baker Hugh~ 2016-09-29T03:~ 2016-09-29T03:4~ actual    &lt;NA&gt;             
#&gt;  2 Baker Hugh~ 2016-09-29T03:~ 2016-09-29T03:4~ actual    SurveyQC=3,Surve~
#&gt;  3 Baker Hugh~ 2016-09-29T03:~ 2016-09-29T03:4~ actual    SurveyQC=3,Surve~
#&gt;  4 Baker Hugh~ 2016-09-29T03:~ 2016-09-29T03:4~ actual    SurveyQC=3,Surve~
#&gt;  5 Baker Hugh~ 2016-09-29T03:~ 2016-09-29T03:4~ actual    SurveyQC=3,Surve~
#&gt;  6 Baker Hugh~ 2016-09-29T03:~ 2016-09-29T03:4~ actual    SurveyQC=3,Surve~
#&gt;  7 Baker Hugh~ 2016-09-29T03:~ 2016-09-29T03:4~ actual    SurveyQC=3,Surve~
#&gt;  8 Baker Hugh~ 2016-09-29T03:~ 2016-09-29T03:4~ actual    SurveyQC=3,Surve~
#&gt;  9 Baker Hugh~ 2016-09-29T03:~ 2016-09-29T03:4~ actual    SurveyQC=3,Surve~
#&gt; 10 Baker Hugh~ 2016-09-29T03:~ 2016-09-29T03:4~ actual    SurveyQC=3,Surve~
#&gt; # ... with 15 more rows</code></pre>
</div>
<div id="part-4-of-4-of-the-trajectorystation-dataframe-corused" class="section level3">
<h3>Part 4 of 4 of the <code>trajectoryStation</code> dataframe: <code>corUsed</code></h3>
<pre class="r"><code># cascading way
xpath &lt;- &quot;//trajectoryStation/corUsed&quot;
xml_find_all(dat, xpath) %&gt;% 
    xml_children() %&gt;% 
    xml_name() %&gt;% 
    unique()
#&gt; [1] &quot;stnGridCorUsed&quot;  &quot;dirSensorOffset&quot;

# get the nodes under trajectoryStation/commonData
tS.cU_df &lt;- nodes_as_df(xml_dat, node = &quot;trajectoryStation/corUsed&quot;, max_obs = 25)
as_tibble(tS.cU_df)
#&gt; # A tibble: 25 x 2
#&gt;    stnGridCorUsed dirSensorOffset
#&gt;    &lt;chr&gt;          &lt;chr&gt;          
#&gt;  1 &lt;NA&gt;           &lt;NA&gt;           
#&gt;  2 999.25         0              
#&gt;  3 999.25         0              
#&gt;  4 999.25         0              
#&gt;  5 999.25         0              
#&gt;  6 999.25         0              
#&gt;  7 999.25         0              
#&gt;  8 999.25         0              
#&gt;  9 999.25         0              
#&gt; 10 999.25         0              
#&gt; # ... with 15 more rows</code></pre>
</div>
<div id="combined-dataframe-for-trajectorystation" class="section level3">
<h3>Combined dataframe for <code>trajectoryStation</code></h3>
<p>Combination of:</p>
<ol style="list-style-type: decimal">
<li>uid attribute</li>
<li>measurement stations data</li>
<li><code>commonData</code>, which originally had children</li>
<li><code>corUsed</code>, also with children nodes</li>
</ol>
<pre class="r"><code># combine all dataframes to make up trajectoryStation dataframe
  # tS.uid_dt: trajectoryStation attributes
  # tS_df: trajectoryStation data
  # tS.cD_df: commonData
trajectoryStation_df &lt;- cbind(tS.uid_dt, 
                              tS_df, 
                              tS.cU_df, 
                              tS.cD_df)

trajectoryStation_dt &lt;- data.table(trajectoryStation_df)</code></pre>
<pre class="r"><code># print the combined table for trajectoryStation
print(as_tibble(trajectoryStation_df))
#&gt; # A tibble: 25 x 26
#&gt;    uid   dTimStn typeTrajStation md    tvd   incl  azi   dispNs dispEw
#&gt;    &lt;chr&gt; &lt;chr&gt;   &lt;chr&gt;           &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;  &lt;chr&gt; 
#&gt;  1 4VIR~ 2016-0~ tie in point    0     0     0     0     0      0     
#&gt;  2 325V~ 2016-0~ gyro north see~ 145.~ 145.~ 0     0     0      0     
#&gt;  3 326V~ 2016-0~ gyro north see~ 218.5 218.~ 0.00~ 3.44~ -0.15~ -0.04~
#&gt;  4 327V~ 2016-0~ gyro north see~ 259   258.~ 0.00~ 4.45~ -0.26~ -0.13~
#&gt;  5 328V~ 2016-0~ gyro north see~ 299.5 299.~ 0.00~ 4.20~ -0.33~ -0.30~
#&gt;  6 329V~ 2016-0~ gyro north see~ 340   339.~ 0.00~ 0.61~ -0.27~ -0.32~
#&gt;  7 330V~ 2016-0~ gyro north see~ 394.~ 394.~ 0.00~ 6.00~ 0.060~ -0.25~
#&gt;  8 331V~ 2016-0~ gyro north see~ 420.~ 420.~ 0.00~ 6.15~ 0.215~ -0.28~
#&gt;  9 332V~ 2016-0~ gyro north see~ 454.~ 454.~ 0.08~ 3.45~ -1.01~ -0.72~
#&gt; 10 333V~ 2016-0~ gyro north see~ 497.~ 497.~ 0.15~ 3.48~ -5.80~ -2.36~
#&gt; # ... with 15 more rows, and 17 more variables: vertSect &lt;chr&gt;, dls &lt;chr&gt;,
#&gt; #   typeSurveyTool &lt;chr&gt;, rateTurn &lt;chr&gt;, rateBuild &lt;chr&gt;,
#&gt; #   gravAccelCorUsed &lt;chr&gt;, magXAxialCorUsed &lt;chr&gt;, sagCorUsed &lt;chr&gt;,
#&gt; #   magDrlstrCorUsed &lt;chr&gt;, statusTrajStation &lt;chr&gt;, stnGridCorUsed &lt;chr&gt;,
#&gt; #   dirSensorOffset &lt;chr&gt;, sourceName &lt;chr&gt;, dTimCreation &lt;chr&gt;,
#&gt; #   dTimLastChange &lt;chr&gt;, itemState &lt;chr&gt;, priv_customData &lt;chr&gt;</code></pre>
</div>
<div id="add-an-id-for-the-tables-relationship" class="section level3">
<h3>Add an id for the tables relationship</h3>
<pre class="r"><code># create a new column id for relationship to another table
id &lt;- trajectoryStation_df[1, uid]
sub_id &lt;- gsub(pattern = &quot;_.*$&quot;, replacement = &quot;&quot;, x = id)
sub_id
#&gt; [1] &quot;4VIRG33&quot;

trajectoryStation_df &lt;- trajectoryStation_df %&gt;% 
    mutate(id = sub_id) %&gt;% 
    select(id, everything()) %&gt;% 
    as_tibble()

trajectoryStation_dt = data.table(trajectoryStation_df)</code></pre>
<pre class="r"><code># chracateristics of the table
dim(trajectoryStation_dt)
#&gt; [1] 25 27
names(trajectoryStation_dt)
#&gt;  [1] &quot;id&quot;                &quot;uid&quot;               &quot;dTimStn&quot;          
#&gt;  [4] &quot;typeTrajStation&quot;   &quot;md&quot;                &quot;tvd&quot;              
#&gt;  [7] &quot;incl&quot;              &quot;azi&quot;               &quot;dispNs&quot;           
#&gt; [10] &quot;dispEw&quot;            &quot;vertSect&quot;          &quot;dls&quot;              
#&gt; [13] &quot;typeSurveyTool&quot;    &quot;rateTurn&quot;          &quot;rateBuild&quot;        
#&gt; [16] &quot;gravAccelCorUsed&quot;  &quot;magXAxialCorUsed&quot;  &quot;sagCorUsed&quot;       
#&gt; [19] &quot;magDrlstrCorUsed&quot;  &quot;statusTrajStation&quot; &quot;stnGridCorUsed&quot;   
#&gt; [22] &quot;dirSensorOffset&quot;   &quot;sourceName&quot;        &quot;dTimCreation&quot;     
#&gt; [25] &quot;dTimLastChange&quot;    &quot;itemState&quot;         &quot;priv_customData&quot;

# TODO: decompose corUsed and add it to the dataframe</code></pre>
</div>
</div>
</div>
<div id="putting-all-together" class="section level1">
<h1>Putting all together</h1>
<pre class="r"><code>print(as_tibble(trajectory_dt))
#&gt; # A tibble: 1 x 17
#&gt;   uidWell uidWellbore uid   nameWell nameWellbore name  objectGrowing
#&gt;   &lt;chr&gt;   &lt;chr&gt;       &lt;chr&gt; &lt;chr&gt;    &lt;chr&gt;        &lt;chr&gt; &lt;chr&gt;        
#&gt; 1 432612~ d1c7a0d7-a~ 4VIR~ NO 15/9~ NO 15/9-F-9~ MWD-~ false        
#&gt; # ... with 10 more variables: dTimTrajStart &lt;chr&gt;, dTimTrajEnd &lt;chr&gt;,
#&gt; #   mdMn &lt;chr&gt;, mdMx &lt;chr&gt;, magDeclUsed &lt;chr&gt;, gridCorUsed &lt;chr&gt;,
#&gt; #   aziVertSect &lt;chr&gt;, dispNsVertSectOrig &lt;chr&gt;, dispEwVertSectOrig &lt;chr&gt;,
#&gt; #   aziRef &lt;chr&gt;</code></pre>
<p>We have one interesting thing going on. We have the <code>trajectory</code> dataframe that is one row and 17 columns (1x17), while <code>trajectoryStation</code> is 25 rows by 27 columns (25x27). How do we work them out in rectangular tables?</p>
<p>We will have to join them. We will use an inner join in <code>data.table</code>.</p>
<div id="join-trajectory-and-trajectorystation-dataframes" class="section level2">
<h2>Join trajectory and trajectoryStation dataframes</h2>
<pre class="r"><code>setkey(trajectory_dt, uid)
setkey(trajectoryStation_dt, id)

# inner join
t_9f9_dt &lt;- trajectory_dt[trajectoryStation_dt, nomatch=0] %&gt;% 
    as_tibble() %&gt;% 
    print()
#&gt; # A tibble: 25 x 43
#&gt;    uidWell uidWellbore uid   nameWell nameWellbore name  objectGrowing
#&gt;    &lt;chr&gt;   &lt;chr&gt;       &lt;chr&gt; &lt;chr&gt;    &lt;chr&gt;        &lt;chr&gt; &lt;chr&gt;        
#&gt;  1 432612~ d1c7a0d7-a~ 4VIR~ NO 15/9~ NO 15/9-F-9~ MWD-~ false        
#&gt;  2 432612~ d1c7a0d7-a~ 4VIR~ NO 15/9~ NO 15/9-F-9~ MWD-~ false        
#&gt;  3 432612~ d1c7a0d7-a~ 4VIR~ NO 15/9~ NO 15/9-F-9~ MWD-~ false        
#&gt;  4 432612~ d1c7a0d7-a~ 4VIR~ NO 15/9~ NO 15/9-F-9~ MWD-~ false        
#&gt;  5 432612~ d1c7a0d7-a~ 4VIR~ NO 15/9~ NO 15/9-F-9~ MWD-~ false        
#&gt;  6 432612~ d1c7a0d7-a~ 4VIR~ NO 15/9~ NO 15/9-F-9~ MWD-~ false        
#&gt;  7 432612~ d1c7a0d7-a~ 4VIR~ NO 15/9~ NO 15/9-F-9~ MWD-~ false        
#&gt;  8 432612~ d1c7a0d7-a~ 4VIR~ NO 15/9~ NO 15/9-F-9~ MWD-~ false        
#&gt;  9 432612~ d1c7a0d7-a~ 4VIR~ NO 15/9~ NO 15/9-F-9~ MWD-~ false        
#&gt; 10 432612~ d1c7a0d7-a~ 4VIR~ NO 15/9~ NO 15/9-F-9~ MWD-~ false        
#&gt; # ... with 15 more rows, and 36 more variables: dTimTrajStart &lt;chr&gt;,
#&gt; #   dTimTrajEnd &lt;chr&gt;, mdMn &lt;chr&gt;, mdMx &lt;chr&gt;, magDeclUsed &lt;chr&gt;,
#&gt; #   gridCorUsed &lt;chr&gt;, aziVertSect &lt;chr&gt;, dispNsVertSectOrig &lt;chr&gt;,
#&gt; #   dispEwVertSectOrig &lt;chr&gt;, aziRef &lt;chr&gt;, i.uid &lt;chr&gt;, dTimStn &lt;chr&gt;,
#&gt; #   typeTrajStation &lt;chr&gt;, md &lt;chr&gt;, tvd &lt;chr&gt;, incl &lt;chr&gt;, azi &lt;chr&gt;,
#&gt; #   dispNs &lt;chr&gt;, dispEw &lt;chr&gt;, vertSect &lt;chr&gt;, dls &lt;chr&gt;,
#&gt; #   typeSurveyTool &lt;chr&gt;, rateTurn &lt;chr&gt;, rateBuild &lt;chr&gt;,
#&gt; #   gravAccelCorUsed &lt;chr&gt;, magXAxialCorUsed &lt;chr&gt;, sagCorUsed &lt;chr&gt;,
#&gt; #   magDrlstrCorUsed &lt;chr&gt;, statusTrajStation &lt;chr&gt;, stnGridCorUsed &lt;chr&gt;,
#&gt; #   dirSensorOffset &lt;chr&gt;, sourceName &lt;chr&gt;, dTimCreation &lt;chr&gt;,
#&gt; #   dTimLastChange &lt;chr&gt;, itemState &lt;chr&gt;, priv_customData &lt;chr&gt;

well_9f9_df &lt;- t_9f9_dt</code></pre>
<pre class="r"><code>names(trajectoryStation_dt)
#&gt;  [1] &quot;id&quot;                &quot;uid&quot;               &quot;dTimStn&quot;          
#&gt;  [4] &quot;typeTrajStation&quot;   &quot;md&quot;                &quot;tvd&quot;              
#&gt;  [7] &quot;incl&quot;              &quot;azi&quot;               &quot;dispNs&quot;           
#&gt; [10] &quot;dispEw&quot;            &quot;vertSect&quot;          &quot;dls&quot;              
#&gt; [13] &quot;typeSurveyTool&quot;    &quot;rateTurn&quot;          &quot;rateBuild&quot;        
#&gt; [16] &quot;gravAccelCorUsed&quot;  &quot;magXAxialCorUsed&quot;  &quot;sagCorUsed&quot;       
#&gt; [19] &quot;magDrlstrCorUsed&quot;  &quot;statusTrajStation&quot; &quot;stnGridCorUsed&quot;   
#&gt; [22] &quot;dirSensorOffset&quot;   &quot;sourceName&quot;        &quot;dTimCreation&quot;     
#&gt; [25] &quot;dTimLastChange&quot;    &quot;itemState&quot;         &quot;priv_customData&quot;</code></pre>
</div>
<div id="apply-the-functions-on-a-second-well" class="section level2">
<h2>Apply the functions on a second well</h2>
<p>Now, this should take less time.</p>
<pre class="r"><code>all_files_xml &lt;- list.files(&quot;./witsml&quot;, recursive = TRUE, full.names = TRUE, 
                        include.dirs = TRUE, pattern = &quot;*.xml&quot;)

# Select the trajectory file
# get the file for trajectory
traj_files &lt;- grep(pattern = &quot;trajectory&quot;, ignore.case = TRUE, 
                   value = TRUE, x = all_files_xml)

dat_9f7 &lt;- read_xml(traj_files[2])</code></pre>
<div id="total-number-of-nodes-for-the-2nd-well" class="section level3">
<h3>Total number of nodes for the 2nd well</h3>
<pre class="r"><code>get_total_number_of_nodes &lt;- function(xml_dat) {
    # get the number of elements
    dat &lt;- xml_ns_strip(xml_dat)
    noe &lt;- xml_dat %&gt;% 
        xml_find_all( &#39;//*&#39;) %&gt;% 
        xml_path() %&gt;% 
        length()
    noe    
}

get_total_number_of_nodes(dat_9f7)
#&gt; [1] 1190</code></pre>
</div>
<div id="trajectory-dataframe-for-the-2nd-well" class="section level3">
<h3><code>trajectory</code> dataframe for the 2nd well</h3>
<pre class="r"><code>get_trajectory_attributes_df &lt;- function(xml_dat) {
    xml_find_first(xml_dat, &quot;//trajectory&quot;) %&gt;% 
    xml_attrs() %&gt;% 
    t() %&gt;% 
    data.frame(stringsAsFactors = FALSE)    
}

# function
get_trajectory_metadata &lt;- function(xml_dat) {
    # get all the trajectory variables, with and without descendants
    trajectory_children &lt;- xml_name(xml_children(xml_find_first(xml_dat, &quot;//trajectory&quot;)))
    
    # get only those variables without descendants. hnc: have no children
    traj_hnc_names &lt;- names(have_no_children(xml_dat, &quot;trajectory&quot;))
    traj_hnc_idx &lt;- which(trajectory_children %in% traj_hnc_names)
    
    traj_hnc &lt;- xml_text(xml_children(xml_find_first(xml_dat, &quot;//trajectory&quot;)))[traj_hnc_idx]
    names(traj_hnc) &lt;- traj_hnc_names
    
    # dataframe and datatable
    data.frame(t(traj_hnc), stringsAsFactors = FALSE)
}

t_attr &lt;- get_trajectory_attributes_df(dat_9f7)
t_meta &lt;- get_trajectory_metadata(dat_9f7)

trajectory_dt &lt;- data.table(cbind(t_attr, t_meta))
trajectory_dt
#&gt;                                 uidWell
#&gt; 1: 5da3aeeb-12c9-4732-a059-e3a8d7c32442
#&gt;                             uidWellbore     uid    nameWell nameWellbore
#&gt; 1: eba2d47b-95f4-468f-856c-32c72d706a96 5VFNI35 NO 15/9-F-7  NO 15/9-F-7
#&gt;            name objectGrowing            dTimTrajStart
#&gt; 1: MWD-15/9-F-7         false 2016-07-28T08:33:43.000Z
#&gt;                 dTimTrajEnd mdMn mdMx magDeclUsed gridCorUsed aziVertSect
#&gt; 1: 2016-07-28T09:26:52.000Z    0 1083           0           0           0
#&gt;    dispNsVertSectOrig dispEwVertSectOrig     aziRef
#&gt; 1:                  0                  0 true north</code></pre>
</div>
<div id="trajectorystation-dataframe-for-the-2nd-well" class="section level3">
<h3><code>trajectoryStation</code> dataframe for the 2nd well</h3>
<pre class="r"><code># uid dataframe
get_trajectoryStation_uid_df &lt;- function(xml_dat) {
    # get values for uid attribute of trajectoryStation
    # these are the well ids
    tS.uid &lt;- xml_dat %&gt;% 
        xml_find_all(&quot;//trajectoryStation&quot;) %&gt;% 
        xml_attr(&quot;uid&quot;)
    as_tibble(data.frame(uid = tS.uid, stringsAsFactors = FALSE))
}

# measurements dataframe
get_trajectoryStation_meas_df &lt;- function(xml_dat) {
    num_trajectoryStation &lt;- get_numrows_parent_node(xml_dat, &quot;trajectoryStation&quot;, 
                                                 attribute = &quot;uid&quot;)
    tS.trajectoryStation_df &lt;- nodes_as_df(xml_dat, &quot;trajectoryStation&quot;, 
                                           num_trajectoryStation)
    as_tibble(tS.trajectoryStation_df)    
}

# commonData
get_trajectoryStation_cData_df &lt;- function(xml_dat, nrows) {
    tS.cD_df &lt;- nodes_as_df(xml_dat, node = &quot;trajectoryStation/commonData&quot;, max_obs = nrows)
    as_tibble(tS.cD_df)    
}

# corUsed
get_trajectoryStation_cUsed_df &lt;- function(xml_dat, nrows) {
    tS.cU_df &lt;- nodes_as_df(xml_dat, node = &quot;trajectoryStation/corUsed&quot;, max_obs = nrows)
    as_tibble(tS.cU_df)
}

# number of rows
num_tS &lt;- get_numrows_parent_node(dat_9f7, &quot;trajectoryStation&quot;, attribute = &quot;uid&quot;)

# build complete dataframe for trajectoryStation
tS.uid_df &lt;- get_trajectoryStation_uid_df(dat_9f7)
tS.measurements_df &lt;- get_trajectoryStation_meas_df(dat_9f7)
tS.corUsed &lt;- get_trajectoryStation_cUsed_df(dat_9f7, num_tS)
tS.commonData_df &lt;- get_trajectoryStation_cData_df(dat_9f7, num_tS)

trajectoryStation_df &lt;- as_tibble(cbind(tS.uid_df,
                              tS.measurements_df, 
                              tS.corUsed, 
                              tS.commonData_df)
                              )

make_id_to_trajectoryStation_dt &lt;- function(tS_df) {
    # create a new column id for relationship to another table
    id &lt;- tS_df[1, &quot;uid&quot;]
    sub_id &lt;- gsub(pattern = &quot;_.*$&quot;, replacement = &quot;&quot;, x = id)
    sub_id
    tS_df &lt;- tS_df %&gt;% 
        mutate(id = sub_id) %&gt;% 
        select(id, everything()) %&gt;% 
        as_tibble()
    data.table(tS_df)
}

trajectoryStation_dt &lt;- make_id_to_trajectoryStation_dt(trajectoryStation_df)
# as_tibble(trajectoryStation_dt)

# inner join

make_trajectory_table &lt;- function(t_dt, tS_dt) {
    setkey(t_dt, &quot;uid&quot;)
    setkey(tS_dt, &quot;id&quot;)
    
    # inner join
    result &lt;- t_dt[tS_dt, nomatch=0]
    result %&gt;% 
    as_tibble()
}

t_9f7_dt &lt;- make_trajectory_table(trajectory_dt, trajectoryStation_dt)
well_9f7_df &lt;- t_9f7_dt
t_9f7_dt
#&gt; # A tibble: 42 x 43
#&gt;    uidWell uidWellbore uid   nameWell nameWellbore name  objectGrowing
#&gt;    &lt;chr&gt;   &lt;chr&gt;       &lt;chr&gt; &lt;chr&gt;    &lt;chr&gt;        &lt;chr&gt; &lt;chr&gt;        
#&gt;  1 5da3ae~ eba2d47b-9~ 5VFN~ NO 15/9~ NO 15/9-F-7  MWD-~ false        
#&gt;  2 5da3ae~ eba2d47b-9~ 5VFN~ NO 15/9~ NO 15/9-F-7  MWD-~ false        
#&gt;  3 5da3ae~ eba2d47b-9~ 5VFN~ NO 15/9~ NO 15/9-F-7  MWD-~ false        
#&gt;  4 5da3ae~ eba2d47b-9~ 5VFN~ NO 15/9~ NO 15/9-F-7  MWD-~ false        
#&gt;  5 5da3ae~ eba2d47b-9~ 5VFN~ NO 15/9~ NO 15/9-F-7  MWD-~ false        
#&gt;  6 5da3ae~ eba2d47b-9~ 5VFN~ NO 15/9~ NO 15/9-F-7  MWD-~ false        
#&gt;  7 5da3ae~ eba2d47b-9~ 5VFN~ NO 15/9~ NO 15/9-F-7  MWD-~ false        
#&gt;  8 5da3ae~ eba2d47b-9~ 5VFN~ NO 15/9~ NO 15/9-F-7  MWD-~ false        
#&gt;  9 5da3ae~ eba2d47b-9~ 5VFN~ NO 15/9~ NO 15/9-F-7  MWD-~ false        
#&gt; 10 5da3ae~ eba2d47b-9~ 5VFN~ NO 15/9~ NO 15/9-F-7  MWD-~ false        
#&gt; # ... with 32 more rows, and 36 more variables: dTimTrajStart &lt;chr&gt;,
#&gt; #   dTimTrajEnd &lt;chr&gt;, mdMn &lt;chr&gt;, mdMx &lt;chr&gt;, magDeclUsed &lt;chr&gt;,
#&gt; #   gridCorUsed &lt;chr&gt;, aziVertSect &lt;chr&gt;, dispNsVertSectOrig &lt;chr&gt;,
#&gt; #   dispEwVertSectOrig &lt;chr&gt;, aziRef &lt;chr&gt;, i.uid &lt;chr&gt;, dTimStn &lt;chr&gt;,
#&gt; #   typeTrajStation &lt;chr&gt;, md &lt;chr&gt;, tvd &lt;chr&gt;, incl &lt;chr&gt;, azi &lt;chr&gt;,
#&gt; #   dispNs &lt;chr&gt;, dispEw &lt;chr&gt;, vertSect &lt;chr&gt;, dls &lt;chr&gt;,
#&gt; #   typeSurveyTool &lt;chr&gt;, rateTurn &lt;chr&gt;, rateBuild &lt;chr&gt;,
#&gt; #   gravAccelCorUsed &lt;chr&gt;, magXAxialCorUsed &lt;chr&gt;, sagCorUsed &lt;chr&gt;,
#&gt; #   magDrlstrCorUsed &lt;chr&gt;, statusTrajStation &lt;chr&gt;, stnGridCorUsed &lt;chr&gt;,
#&gt; #   dirSensorOffset &lt;chr&gt;, sourceName &lt;chr&gt;, dTimCreation &lt;chr&gt;,
#&gt; #   dTimLastChange &lt;chr&gt;, itemState &lt;chr&gt;, priv_customData &lt;chr&gt;</code></pre>
</div>
</div>
<div id="test-the-well-dataframe-structures" class="section level2">
<h2>Test the well dataframe structures</h2>
<p>We test if both wells have identical variables otherwise we couldn’t be able to combine them. This is also a test that our functions are working well so far, at least for these two wells. Adding more wells could present a challenge if the new well has stored a different number of variables, so, the functions will have to check for all possible cases.</p>
<pre class="r"><code># compare the two wells
identical(names(t_9f9_dt), names(t_9f7_dt))
#&gt; [1] TRUE</code></pre>
</div>
</div>
<div id="making-it-reproducible" class="section level1">
<h1>Making it reproducible</h1>
<p>Now, we can put all these functions in an R script, and everything should work much faster. In this example, we are converting the WITSML to dataframes for well <em>Norway-Statoil-NO 15_$47$_9-F-7</em>. We will call it by the last identifier <code>9f7</code> from now on. You will see that this well has more trajectory stations; 43 to be exact. Many more than the first well <code>9f9</code> that corresponds to well <em>Norway-Statoil-NO 15_$47$_9-F-9</em>.</p>
<pre class="r"><code>source(&quot;witsml-trajectory.R&quot;)

all_files_xml &lt;- list.files(&quot;./witsml&quot;, recursive = TRUE, full.names = TRUE, 
                        include.dirs = TRUE, pattern = &quot;*.xml&quot;)

# Select the trajectory file
# get the file for trajectory
traj_files &lt;- grep(pattern = &quot;trajectory&quot;, ignore.case = TRUE, 
                   value = TRUE, x = all_files_xml)

well_9f7 &lt;- traj_files[2]

well_9f7_df &lt;- convert_witsml_to_df(well_9f7)
well_9f7_df
#&gt; # A tibble: 42 x 43
#&gt;    uidWell uidWellbore uid   nameWell nameWellbore name  objectGrowing
#&gt;    &lt;chr&gt;   &lt;chr&gt;       &lt;chr&gt; &lt;chr&gt;    &lt;chr&gt;        &lt;chr&gt; &lt;chr&gt;        
#&gt;  1 5da3ae~ eba2d47b-9~ 5VFN~ NO 15/9~ NO 15/9-F-7  MWD-~ false        
#&gt;  2 5da3ae~ eba2d47b-9~ 5VFN~ NO 15/9~ NO 15/9-F-7  MWD-~ false        
#&gt;  3 5da3ae~ eba2d47b-9~ 5VFN~ NO 15/9~ NO 15/9-F-7  MWD-~ false        
#&gt;  4 5da3ae~ eba2d47b-9~ 5VFN~ NO 15/9~ NO 15/9-F-7  MWD-~ false        
#&gt;  5 5da3ae~ eba2d47b-9~ 5VFN~ NO 15/9~ NO 15/9-F-7  MWD-~ false        
#&gt;  6 5da3ae~ eba2d47b-9~ 5VFN~ NO 15/9~ NO 15/9-F-7  MWD-~ false        
#&gt;  7 5da3ae~ eba2d47b-9~ 5VFN~ NO 15/9~ NO 15/9-F-7  MWD-~ false        
#&gt;  8 5da3ae~ eba2d47b-9~ 5VFN~ NO 15/9~ NO 15/9-F-7  MWD-~ false        
#&gt;  9 5da3ae~ eba2d47b-9~ 5VFN~ NO 15/9~ NO 15/9-F-7  MWD-~ false        
#&gt; 10 5da3ae~ eba2d47b-9~ 5VFN~ NO 15/9~ NO 15/9-F-7  MWD-~ false        
#&gt; # ... with 32 more rows, and 36 more variables: dTimTrajStart &lt;chr&gt;,
#&gt; #   dTimTrajEnd &lt;chr&gt;, mdMn &lt;chr&gt;, mdMx &lt;chr&gt;, magDeclUsed &lt;chr&gt;,
#&gt; #   gridCorUsed &lt;chr&gt;, aziVertSect &lt;chr&gt;, dispNsVertSectOrig &lt;chr&gt;,
#&gt; #   dispEwVertSectOrig &lt;chr&gt;, aziRef &lt;chr&gt;, i.uid &lt;chr&gt;, dTimStn &lt;chr&gt;,
#&gt; #   typeTrajStation &lt;chr&gt;, md &lt;chr&gt;, tvd &lt;chr&gt;, incl &lt;chr&gt;, azi &lt;chr&gt;,
#&gt; #   dispNs &lt;chr&gt;, dispEw &lt;chr&gt;, vertSect &lt;chr&gt;, dls &lt;chr&gt;,
#&gt; #   typeSurveyTool &lt;chr&gt;, rateTurn &lt;chr&gt;, rateBuild &lt;chr&gt;,
#&gt; #   gravAccelCorUsed &lt;chr&gt;, magXAxialCorUsed &lt;chr&gt;, sagCorUsed &lt;chr&gt;,
#&gt; #   magDrlstrCorUsed &lt;chr&gt;, statusTrajStation &lt;chr&gt;, stnGridCorUsed &lt;chr&gt;,
#&gt; #   dirSensorOffset &lt;chr&gt;, sourceName &lt;chr&gt;, dTimCreation &lt;chr&gt;,
#&gt; #   dTimLastChange &lt;chr&gt;, itemState &lt;chr&gt;, priv_customData &lt;chr&gt;</code></pre>
<div id="combine-the-observations-of-the-two-wells-with-rbind" class="section level2">
<h2>Combine the observations of the two wells with <code>rbind</code></h2>
<p>Now it’s the time to combine the measurements of both wells. We use the <code>rbind()</code> function which glue them by rows. Now, we should have 67 rows.</p>
<pre class="r"><code># bind two wells and create a common dataframe
all_wells &lt;- rbind(well_9f7_df, well_9f9_df)
all_wells
#&gt; # A tibble: 67 x 43
#&gt;    uidWell uidWellbore uid   nameWell nameWellbore name  objectGrowing
#&gt;    &lt;chr&gt;   &lt;chr&gt;       &lt;chr&gt; &lt;chr&gt;    &lt;chr&gt;        &lt;chr&gt; &lt;chr&gt;        
#&gt;  1 5da3ae~ eba2d47b-9~ 5VFN~ NO 15/9~ NO 15/9-F-7  MWD-~ false        
#&gt;  2 5da3ae~ eba2d47b-9~ 5VFN~ NO 15/9~ NO 15/9-F-7  MWD-~ false        
#&gt;  3 5da3ae~ eba2d47b-9~ 5VFN~ NO 15/9~ NO 15/9-F-7  MWD-~ false        
#&gt;  4 5da3ae~ eba2d47b-9~ 5VFN~ NO 15/9~ NO 15/9-F-7  MWD-~ false        
#&gt;  5 5da3ae~ eba2d47b-9~ 5VFN~ NO 15/9~ NO 15/9-F-7  MWD-~ false        
#&gt;  6 5da3ae~ eba2d47b-9~ 5VFN~ NO 15/9~ NO 15/9-F-7  MWD-~ false        
#&gt;  7 5da3ae~ eba2d47b-9~ 5VFN~ NO 15/9~ NO 15/9-F-7  MWD-~ false        
#&gt;  8 5da3ae~ eba2d47b-9~ 5VFN~ NO 15/9~ NO 15/9-F-7  MWD-~ false        
#&gt;  9 5da3ae~ eba2d47b-9~ 5VFN~ NO 15/9~ NO 15/9-F-7  MWD-~ false        
#&gt; 10 5da3ae~ eba2d47b-9~ 5VFN~ NO 15/9~ NO 15/9-F-7  MWD-~ false        
#&gt; # ... with 57 more rows, and 36 more variables: dTimTrajStart &lt;chr&gt;,
#&gt; #   dTimTrajEnd &lt;chr&gt;, mdMn &lt;chr&gt;, mdMx &lt;chr&gt;, magDeclUsed &lt;chr&gt;,
#&gt; #   gridCorUsed &lt;chr&gt;, aziVertSect &lt;chr&gt;, dispNsVertSectOrig &lt;chr&gt;,
#&gt; #   dispEwVertSectOrig &lt;chr&gt;, aziRef &lt;chr&gt;, i.uid &lt;chr&gt;, dTimStn &lt;chr&gt;,
#&gt; #   typeTrajStation &lt;chr&gt;, md &lt;chr&gt;, tvd &lt;chr&gt;, incl &lt;chr&gt;, azi &lt;chr&gt;,
#&gt; #   dispNs &lt;chr&gt;, dispEw &lt;chr&gt;, vertSect &lt;chr&gt;, dls &lt;chr&gt;,
#&gt; #   typeSurveyTool &lt;chr&gt;, rateTurn &lt;chr&gt;, rateBuild &lt;chr&gt;,
#&gt; #   gravAccelCorUsed &lt;chr&gt;, magXAxialCorUsed &lt;chr&gt;, sagCorUsed &lt;chr&gt;,
#&gt; #   magDrlstrCorUsed &lt;chr&gt;, statusTrajStation &lt;chr&gt;, stnGridCorUsed &lt;chr&gt;,
#&gt; #   dirSensorOffset &lt;chr&gt;, sourceName &lt;chr&gt;, dTimCreation &lt;chr&gt;,
#&gt; #   dTimLastChange &lt;chr&gt;, itemState &lt;chr&gt;, priv_customData &lt;chr&gt;</code></pre>
</div>
<div id="simplify-the-data-structure-by-nesting-the-two-wells" class="section level2">
<h2>Simplify the data structure by nesting the two wells</h2>
<p>With the two wells put together we should be almost ready. But we don’t want to show all the measurements; we want just to focus on the wells. So far, we have two wells with 67 rows but what about later when we have ten or a hundred. Then, it would consume lot of memory and screen to see through all those records.</p>
<p>What we want is to show only the wells and start performing operations directly on them. We do this by using the <code>tidyr</code> function <code>nest()</code>.</p>
<pre class="r"><code># nest the two well so they show as one row each
wells_nested &lt;-
    all_wells %&gt;% 
    nest(-uid) %&gt;% 
    print()
#&gt; # A tibble: 2 x 2
#&gt;   uid     data              
#&gt;   &lt;chr&gt;   &lt;list&gt;            
#&gt; 1 5VFNI35 &lt;tibble [42 x 42]&gt;
#&gt; 2 4VIRG33 &lt;tibble [25 x 42]&gt;</code></pre>
</div>
<div id="add-new-wells" class="section level2">
<h2>Add new wells</h2>
<p>We will add one more well: <em>Norway-Statoil-NO 15_$47$_9-F-4</em>. This well has 87 measurement points for its trajectory, which is the same as saying that the well has 87 <code>trajectoryStation</code> items.</p>
<p>This time we use only one function <code>convert_witsml_to_df()</code>, one that resides in the script <code>witsml-trajectory.R</code>. This function performs all the data extraction and conversion that we saw at the beginning.</p>
<pre class="r"><code># convert a WITSML trajectory to dataframe
well_9f4  &lt;- traj_files[1] 
well_9f4_df &lt;- convert_witsml_to_df(well_9f4)
well_9f4_df
#&gt; # A tibble: 87 x 43
#&gt;    uidWell uidWellbore uid   nameWell nameWellbore name  objectGrowing
#&gt;    &lt;chr&gt;   &lt;chr&gt;       &lt;chr&gt; &lt;chr&gt;    &lt;chr&gt;        &lt;chr&gt; &lt;chr&gt;        
#&gt;  1 5e023a~ dbffce7a-7~ 5VIR~ NO 15/9~ NO 15/9-F-4  MWD-~ false        
#&gt;  2 5e023a~ dbffce7a-7~ 5VIR~ NO 15/9~ NO 15/9-F-4  MWD-~ false        
#&gt;  3 5e023a~ dbffce7a-7~ 5VIR~ NO 15/9~ NO 15/9-F-4  MWD-~ false        
#&gt;  4 5e023a~ dbffce7a-7~ 5VIR~ NO 15/9~ NO 15/9-F-4  MWD-~ false        
#&gt;  5 5e023a~ dbffce7a-7~ 5VIR~ NO 15/9~ NO 15/9-F-4  MWD-~ false        
#&gt;  6 5e023a~ dbffce7a-7~ 5VIR~ NO 15/9~ NO 15/9-F-4  MWD-~ false        
#&gt;  7 5e023a~ dbffce7a-7~ 5VIR~ NO 15/9~ NO 15/9-F-4  MWD-~ false        
#&gt;  8 5e023a~ dbffce7a-7~ 5VIR~ NO 15/9~ NO 15/9-F-4  MWD-~ false        
#&gt;  9 5e023a~ dbffce7a-7~ 5VIR~ NO 15/9~ NO 15/9-F-4  MWD-~ false        
#&gt; 10 5e023a~ dbffce7a-7~ 5VIR~ NO 15/9~ NO 15/9-F-4  MWD-~ false        
#&gt; # ... with 77 more rows, and 36 more variables: dTimTrajStart &lt;chr&gt;,
#&gt; #   dTimTrajEnd &lt;chr&gt;, mdMn &lt;chr&gt;, mdMx &lt;chr&gt;, magDeclUsed &lt;chr&gt;,
#&gt; #   gridCorUsed &lt;chr&gt;, aziVertSect &lt;chr&gt;, dispNsVertSectOrig &lt;chr&gt;,
#&gt; #   dispEwVertSectOrig &lt;chr&gt;, aziRef &lt;chr&gt;, i.uid &lt;chr&gt;, dTimStn &lt;chr&gt;,
#&gt; #   typeTrajStation &lt;chr&gt;, md &lt;chr&gt;, tvd &lt;chr&gt;, incl &lt;chr&gt;, azi &lt;chr&gt;,
#&gt; #   dispNs &lt;chr&gt;, dispEw &lt;chr&gt;, vertSect &lt;chr&gt;, dls &lt;chr&gt;,
#&gt; #   typeSurveyTool &lt;chr&gt;, rateTurn &lt;chr&gt;, rateBuild &lt;chr&gt;,
#&gt; #   gravAccelCorUsed &lt;chr&gt;, magXAxialCorUsed &lt;chr&gt;, sagCorUsed &lt;chr&gt;,
#&gt; #   magDrlstrCorUsed &lt;chr&gt;, statusTrajStation &lt;chr&gt;, stnGridCorUsed &lt;chr&gt;,
#&gt; #   dirSensorOffset &lt;chr&gt;, sourceName &lt;chr&gt;, dTimCreation &lt;chr&gt;,
#&gt; #   dTimLastChange &lt;chr&gt;, itemState &lt;chr&gt;, priv_customData &lt;chr&gt;</code></pre>
</div>
<div id="nest-the-new-well" class="section level2">
<h2>Nest the new well</h2>
<p>So, we have 87 trajectory measurements for the well. Again, we don’t want to see all of them but just the well. So, we nest the structure. What we will see from now on is one row representing the well with its <code>uid</code>.</p>
<p>Later, if you need to undo the nesting operation, you just use the function <code>unnest()</code>.</p>
<pre class="r"><code># nesting the new well
nested_9f4 &lt;-
    well_9f4_df %&gt;% 
    nest(-uid) %&gt;% 
    print()
#&gt; # A tibble: 1 x 2
#&gt;   uid     data              
#&gt;   &lt;chr&gt;   &lt;list&gt;            
#&gt; 1 5VIRG33 &lt;tibble [87 x 42]&gt;</code></pre>
<p>The new well should be able now to join the other two wells nested structure. It should be a straight operation with the function <code>rbind()</code>. Since all of them are just one row, at the end of the binding we should have now three rows. The trajectory measurements are living as a list component in the column <code>data</code>.</p>
<pre class="r"><code># bind the existing wells with the new one
wells_nested_3 &lt;- rbind(wells_nested, nested_9f4)
wells_nested_3
#&gt; # A tibble: 3 x 2
#&gt;   uid     data              
#&gt;   &lt;chr&gt;   &lt;list&gt;            
#&gt; 1 5VFNI35 &lt;tibble [42 x 42]&gt;
#&gt; 2 4VIRG33 &lt;tibble [25 x 42]&gt;
#&gt; 3 5VIRG33 &lt;tibble [87 x 42]&gt;</code></pre>
</div>
<div id="transforming-the-drilling-data" class="section level2">
<h2>Transforming the drilling data</h2>
<p>The next step is performing some operations with the data in the nested structures. First, we want to do the type conversion of few of the variables. We should convert the character types to the double type for the variables:</p>
<pre><code>md
tvd
incl
azi
rateTurn
rateBuild</code></pre>
<p>After they are converted to numeric variables, we will be able to plot them and start making discoveries.</p>
<pre class="r"><code>wells_kvars &lt;- 
    wells_nested_3 %&gt;%   # this is the nested structure
    unnest(data) %&gt;%     # unnest and select the variables
    select(nameWell, md, tvd, incl, azi, rateTurn, rateBuild) %&gt;% 
    mutate(md = as.double(md), tvd = as.double(tvd),    # convert to double
           incl = as.double(incl), azi = as.double(azi),
           rateTurn = as.double(rateTurn), rateBuild = as.double(rateBuild)) %&gt;% 
    print()
#&gt; # A tibble: 154 x 7
#&gt;    nameWell       md   tvd    incl   azi  rateTurn   rateBuild
#&gt;    &lt;chr&gt;       &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;       &lt;dbl&gt;
#&gt;  1 NO 15/9-F-7    0     0  0        0     NA        NA        
#&gt;  2 NO 15/9-F-7  146.  146. 0        0      0         0        
#&gt;  3 NO 15/9-F-7  160   160. 0.00401  4.79  -0.106     0.000285 
#&gt;  4 NO 15/9-F-7  170   170. 0.00454  4.76  -0.00284   0.0000524
#&gt;  5 NO 15/9-F-7  180   180. 0.00524  4.58  -0.0186    0.0000698
#&gt;  6 NO 15/9-F-7  190   190. 0.00384  4.67   0.00965  -0.000140 
#&gt;  7 NO 15/9-F-7  199   199. 0.00559  4.54  -0.0142    0.000194 
#&gt;  8 NO 15/9-F-7  208   208. 0.00541  3.96  -0.0651   -0.0000194
#&gt;  9 NO 15/9-F-7  218   218. 0.00698  4.27   0.0314    0.000157 
#&gt; 10 NO 15/9-F-7  229   229. 0.00436  4.36   0.00820  -0.000238 
#&gt; # ... with 144 more rows</code></pre>
</div>
<div id="plotting-drilling-data" class="section level2">
<h2>Plotting drilling data</h2>
<p>With the variables now converted to double, we start plotting them. The first plot will be MD vs TVD to find out how deviated is the well.</p>
<pre class="r"><code># MD vs TVD for three wells
library(ggplot2)
ggplot(wells_kvars, aes(x = md, y = tvd, color = nameWell)) +
    geom_line(size=1) +
    labs(title = &quot;MD vs TVD for three wells&quot;)</code></pre>
<p><img src="/publications/2019-01-27-exploring-drilling-data-with-witsml-and-r_files/figure-html/unnamed-chunk-55-1.png" width="672" style="display: block; margin: auto;" /></p>
</div>
<div id="facet-plot-of-md-vs-tvd" class="section level2">
<h2>Facet plot of MD vs TVD</h2>
<p>Here is another way of visualizing the plot above. We use facets to get rid of that overlapping in the former plot.</p>
<pre class="r"><code># plot facets of the three wells
# MD vs TVD for three wells
ggplot(wells_kvars, aes(x = md, y = tvd, color = nameWell)) +
    geom_line(size=1) +
    facet_grid(. ~ nameWell) +
    labs(title = &quot;MD vs TVD for three wells&quot;)</code></pre>
<p><img src="/publications/2019-01-27-exploring-drilling-data-with-witsml-and-r_files/figure-html/unnamed-chunk-56-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>Next, it is the turn of inclination vs azimut.</p>
<pre class="r"><code># Inclination vs Azimuth for three wells
ggplot(wells_kvars, aes(x = incl, y = azi, color = nameWell)) +
    geom_line(size=1) +
    facet_grid(. ~ nameWell) +
    labs(title = &quot;Inclination vs Azimuth for three wells&quot;)</code></pre>
<p><img src="/publications/2019-01-27-exploring-drilling-data-with-witsml-and-r_files/figure-html/unnamed-chunk-57-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>We notice that the x-axis remains the same for al of the plots. We can set it free to let the x axis expand and follow the data. Just be careful in reading the data in the x-axis; they are not fixed anymore.</p>
<pre class="r"><code># # rateTurn in radians per meter
ggplot(wells_kvars, aes(x = tvd, y = rateTurn, color = nameWell)) +
    geom_line(size=1) +
    facet_grid(. ~ nameWell, scales=&quot;free_x&quot;) +
    labs(title = &quot;TVD vs Rate of Turn for three wells&quot;)</code></pre>
<p><img src="/publications/2019-01-27-exploring-drilling-data-with-witsml-and-r_files/figure-html/unnamed-chunk-58-1.png" width="672" style="display: block; margin: auto;" /></p>
<p>We do the same with the plot TVD vs Rate of Build.</p>
<pre class="r"><code># rateBuild in radians per meter
ggplot(wells_kvars, aes(x = tvd, y = rateBuild, color = nameWell)) +
    geom_line(size=1) +
    facet_grid(. ~ nameWell, scales = &quot;free_x&quot;) +
    labs(title = &quot;TVD vs Rate of Build for three wells&quot;)</code></pre>
<p><img src="/publications/2019-01-27-exploring-drilling-data-with-witsml-and-r_files/figure-html/unnamed-chunk-59-1.png" width="672" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="notes" class="section level1">
<h1>Notes</h1>
<ul>
<li><p>For the first row of <code>trajectoryStation</code>, which corresponds to the <code>TIE_POINT</code>, fill all the empty variables (those absent) with <code>NA</code>. The <code>data.table</code> function works very well compensating those variables that are incomplete but filling them with default values, which is not good. We see, for instance, that for first member of the <code>trajectoryStation</code>, the variables present are only 10. Normally, they should be 20, if we count <code>commonData</code> and <code>corUsed</code>, which are the only two which have children nodes.</p></li>
<li><p>In upcoming versions, we should take care of coercing the variables to their corresponding types. By default, in this example, we’ve got all the variables as character. Since we know in advance the data types because of the WITSML standard, we could use the <strong>R</strong> package <code>readr</code> to do the coercion.</p></li>
<li><p>As we get familiar with the WITSML hierarchies, we could start using loops or <code>apply</code> functions to convert the tree structures to dataframes.</p></li>
<li><p>Functions can be implemented later to get the number of trajectory stations, find which <code>trajectoryStation</code> does not have its complete set of variables, or extract a particular trajectory measurement.</p></li>
<li><p>In this long example, we used only one well for the details. That’s why we obtained only one trajectory file. Other wells could have more than one trajectory file. Later we could implement a function that scans all the folders and generates a summary statistic of the number of folders, number of files per well, size, etc. <strong>Update</strong>. We added lately two more wells.</p></li>
</ul>
</div>
<div id="references" class="section level1">
<h1>References</h1>
<p>WITSML 1.3.1.1: <a href="http://w3.energistics.org/schema/witsml_v1.3.1.1_data/doc/WITSML_Schema_docu.htm" class="uri">http://w3.energistics.org/schema/witsml_v1.3.1.1_data/doc/WITSML_Schema_docu.htm</a></p>
<p>WITSML 1.4.0 schema: <a href="http://w3.energistics.org/schema/witsml_v1.4.0_data/doc/witsml_schema_overview.html" class="uri">http://w3.energistics.org/schema/witsml_v1.4.0_data/doc/witsml_schema_overview.html</a></p>
</div>
<div class="footnotes">
<hr />
<ol>
<li id="fn1"><p>Software Development Kit<a href="#fnref1" class="footnote-back">↩</a></p></li>
<li id="fn2"><p>A Microsoft development platform<a href="#fnref2" class="footnote-back">↩</a></p></li>
<li id="fn3"><p>A Microsoft flavor of C++<a href="#fnref3" class="footnote-back">↩</a></p></li>
</ol>
</div>
